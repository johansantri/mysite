{% extends 'home/base.html' %}
{% block content %}
<div class="container mt-5">
    <h2 class="mb-4">Dashboard Lisensi (PT A)</h2>

    <!-- Menampilkan pesan -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}

    <!-- Statistik undangan -->
    <div class="mb-3">
        <p><strong>Statistik Undangan:</strong> {{ invitation_stats.pending }} Menunggu, {{ invitation_stats.accepted }} Diterima, {{ invitation_stats.expired }} Kadaluarsa</p>
    </div>

    <!-- Bagian untuk menampilkan lisensi -->
    <h3 class="mb-3">Lisensi Anda</h3>
    {% if licenses %}
        <div class="table-responsive">
            <table class="table table-striped table-bordered">
                <thead class="table-dark">
                    <tr>
                        <th scope="col">Nama</th>
                        <th scope="col">Tipe</th>
                        <th scope="col">Tanggal Mulai</th>
                        <th scope="col">Tanggal Berakhir</th>
                        <th scope="col">Status</th>
                        <th scope="col">Pengguna</th>
                    </tr>
                </thead>
                <tbody>
                    {% for license in licenses %}
                        <tr>
                            <td>{{ license.name }}</td>
                            <td>{{ license.get_license_type_display }}</td>
                            <td>{{ license.start_date }}</td>
                            <td>{{ license.expiry_date }}</td>
                            <td>
                                {% if license.status %}
                                    <span class="badge bg-success">Aktif</span>
                                {% else %}
                                    <span class="badge bg-danger">Tidak Aktif</span>
                                {% endif %}
                            </td>
                            <td>{{ license.users.count }} / {{ license.max_users }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="alert alert-info" role="alert">
            Tidak ada lisensi ditemukan. Silakan hubungi Super Admin untuk membuat lisensi.
        </div>
    {% endif %}

    <!-- Bagian untuk menampilkan kursus dan peserta -->
    <h3 class="mb-3 mt-5">Kursus yang Diikuti Peserta</h3>
    {% for license_data in license_course_data %}
        <h4>Lisensi: {{ license_data.license.name }}</h4>
        {% if license_data.courses %}
            {% for course_data in license_data.courses %}
                <div class="card mb-3">
                    <div class="card-header">
                        <h5>Kursus: {{ course_data.course.course_name }} ({{ course_data.enrollment_count }} Peserta)</h5>
                    </div>
                    <div class="card-body">
                        {% if course_data.enrollments %}
                            <div class="table-responsive">
                                <table class="table table-striped table-bordered">
                                    <thead class="table-dark">
                                        <tr>
                                            <th scope="col">Nama Peserta</th>
                                            <th scope="col">Email</th>
                                            <th scope="col">Tanggal Pendaftaran</th>
                                            <th scope="col">Sertifikat Diterbitkan</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for enrollment in course_data.enrollments %}
                                            <tr>
                                                <td>{{ enrollment.user.username }}</td>
                                                <td>{{ enrollment.user.email }}</td>
                                                <td>{{ enrollment.enrolled_at|date:"Y-m-d H:i" }}</td>
                                                <td>
                                                    {% if enrollment.certificate_issued %}
                                                        <span class="badge bg-success">Ya</span>
                                                    {% else %}
                                                        <span class="badge bg-warning">Belum</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <p>Tidak ada peserta yang mendaftar di kursus ini.</p>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="alert alert-info" role="alert">
                Tidak ada peserta yang mendaftar ke kursus dari lisensi ini.
            </div>
        {% endif %}
    {% endfor %}

    <!-- Bagian untuk menampilkan undangan -->
    <h3 class="mb-3 mt-5">Undangan Anda</h3>

    <!-- Form filter dan pencarian -->
    <form method="GET" class="mb-3">
        <div class="row g-3 align-items-end">
            <div class="col-md-4">
                <label for="statusFilter" class="form-label">Filter berdasarkan Status</label>
                <select name="status" id="statusFilter" class="form-select">
                    <option value="">Semua</option>
                    <option value="pending" {% if status == 'pending' %}selected{% endif %}>Menunggu</option>
                    <option value="accepted" {% if status == 'accepted' %}selected{% endif %}>Diterima</option>
                    <option value="expired" {% if status == 'expired' %}selected{% endif %}>Kadaluarsa</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="searchInput" class="form-label">Cari berdasarkan Email</label>
                <input type="text" name="search" id="searchInput" class="form-control" value="{{ search_query|default:'' }}" placeholder="Masukkan email...">
            </div>
            <div class="col-md-4">
                <button type="submit" class="btn btn-primary">Terapkan</button>
                <a href="{% url 'licensing:licens_dashboard' %}" class="btn btn-secondary">Reset</a>
            </div>
        </div>
    </form>

    <!-- Tombol Undang Sekarang -->
    <a href="{% url 'licensing:send_invitation' %}" class="btn btn-primary mb-3">
        <i class="bi bi-plus-circle"></i> Undang Sekarang
    </a>

    <!-- Tabel undangan -->
    {% if invitations %}
        <div class="table-responsive">
            <table class="table table-striped table-bordered">
                <thead class="table-dark">
                    <tr>
                        <th scope="col">Email Penerima</th>
                        <th scope="col">Lisensi</th>
                        <th scope="col">Status</th>
                        <th scope="col">Tanggal Undangan</th>
                        <th scope="col">Tanggal Kadaluarsa</th>
                        <th scope="col">Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    {% for invitation in invitations %}
                        <tr>
                            <td>{{ invitation.invitee_email }}</td>
                            <td>{{ invitation.license.name|default:"Tidak Ada Lisensi" }}</td>
                            <td>
                                {% if invitation.status == 'pending' %}
                                    <span class="badge bg-warning">Menunggu</span>
                                {% elif invitation.status == 'accepted' %}
                                    <span class="badge bg-success">Diterima</span>
                                {% else %}
                                    <span class="badge bg-danger">Kadaluarsa</span>
                                {% endif %}
                            </td>
                            <td>{{ invitation.invitation_date|date:"Y-m-d H:i" }}</td>
                            <td>{{ invitation.expiry_date|date:"Y-m-d H:i" }}</td>
                            <td>
                                {% if invitation.status != 'accepted' %}
                                    <a href="{% url 'licensing:resend_invitation' invitation.id %}" class="btn btn-sm btn-info">
                                        <i class="bi bi-arrow-repeat"></i> Kirim Ulang
                                    </a>
                                {% endif %}
                                <a href="{% url 'licensing:cancel_invitation' invitation.id %}" class="btn btn-sm btn-danger" onclick="return confirm('Apakah Anda yakin ingin membatalkan undangan ini?')">
                                    <i class="bi bi-trash"></i> Batal
                                </a>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Paginasi -->
        <nav aria-label="Navigasi halaman">
            <ul class="pagination">
                {% if invitations.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ invitations.previous_page_number }}{% if status %}&status={{ status }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}">Sebelumnya</a>
                    </li>
                {% endif %}
                {% for num in invitations.paginator.page_range %}
                    <li class="page-item {% if invitations.number == num %}active{% endif %}">
                        <a class="page-link" href="?page={{ num }}{% if status %}&status={{ status }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}">{{ num }}</a>
                    </li>
                {% endfor %}
                {% if invitations.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ invitations.next_page_number }}{% if status %}&status={{ status }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}">Berikutnya</a>
                    </li>
                {% endif %}
            </ul>
        </nav>
    {% else %}
        <div class="alert alert-info" role="alert">
            Tidak ada undangan yang dikirim.
        </div>
    {% endif %}
</div>
{% endblock %}