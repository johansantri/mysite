{% extends 'home/tes.html' %}
{% load static %}

{% block content %}
<!-- Dashboard Grid -->
<div class="container mt-5">
    <h2 class="mb-4 text-center"><a href="{% url 'courses:studio' course.id %}">{{ course.course_name }}</a></h2>

    <!-- Status dan Pesan -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Current Status</h5>
            <p class="card-text">
                <strong>Status:</strong>
                {% if course.status_course == 'curation' %}
                    <span class="badge bg-primary">{{ course.status_course.get_status_display }}</span>
                {% elif course.status_course == 'draft' %}
                    <span class="badge bg-warning">{{ course.status_course.get_status_display }}</span>
                {% elif course.status_course == 'published' %}
                    <span class="badge bg-success">{{ course.status_course.get_status_display }}</span>
                {% elif course.status_course == 'rejected' %}
                    <span class="badge bg-danger">{{ course.status_course.get_status_display }}</span>
                {% else %}
                    <span class="badge bg-secondary">{{ course.status_course.get_status_display }}</span>
                {% endif %}
            </p>
            <p><strong>Latest Message:</strong> {{ course.status_course.manual_message|default:"No message" }}</p>
        </div>
    </div>

    <!-- Informasi Author -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Information Partner</h5>
            <ul class="list-group">
                <li class="list-group-item"><strong>Full Name:</strong> {{ author_full_name }}</li>
                <li class="list-group-item"><strong>Email:</strong> {{ author_email }}</li>
                <li class="list-group-item"><strong>University:</strong> {{ author_university }}</li>
                <li class="list-group-item"><strong>Gender:</strong> {{ author_gender|title }}</li>
            </ul>
        </div>
    </div>

    <!-- Detail Kursus -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Course Details</h5>
            <ul class="list-group">
                <li class="list-group-item"><strong>Partner:</strong> {{ course.org_partner.name }}</li>
                <li class="list-group-item"><strong>Instructor:</strong> {{ course.instructor.user.username|default:"Not assigned" }}</li>
                <li class="list-group-item"><strong>Category:</strong> {{ course.category.name }}</li>
                <li class="list-group-item"><strong>Level:</strong> {{ course.level|title }}</li>
                <li class="list-group-item"><strong>Language:</strong> {{ course.get_language_display }}</li>
                <li class="list-group-item"><strong>Start Date:</strong> {{ course.start_date|default:"N/A" }}</li>
                <li class="list-group-item"><strong>End Date:</strong> {{ course.end_date|default:"N/A" }}</li>
            </ul>
        </div>
    </div>

    <!-- Riwayat Status -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Status History</h5>
            {% if status_history %}
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Status</th>
                        <th>Action</th>
                        <th>Message</th>
                        <th>Changed By</th>
                        <th>Changed At</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in status_history %}
                    <tr {% if "Rejected" in action %}class="table-danger"{% elif "Published" in action %}class="table-success"{% endif %}>
                        <td>{{ entry.get_status_display }}</td>
                        <td>
                            {% if entry.status == 'curation' and entry.changed_by.is_instructor %}
                                <span class="badge bg-primary">Submitted for Curation</span>
                            {% elif entry.status == 'curation' and entry.changed_by.is_partner %}
                                <span class="badge bg-info">Accepted by Partner</span>
                            {% elif entry.status == 'draft' and entry.changed_by.is_partner %}
                                <span class="badge bg-danger">Rejected by Partner</span>
                            {% elif entry.status == 'published' and entry.changed_by.is_superuser %}
                                <span class="badge bg-success">Published by Superuser</span>
                            {% elif entry.status == 'curation' and entry.changed_by.is_superuser %}
                                <span class="badge bg-danger">Rejected by Superuser</span>
                            {% else %}
                                <span class="badge bg-secondary">Updated</span>
                            {% endif %}
                        </td>
                        <td>{{ entry.manual_message|default:"No message" }}</td>
                        <td>{{ entry.changed_by.username }}</td>
                        <td>{{ entry.changed_at|date:"Y-m-d H:i:s" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p>No status history available.</p>
            {% endif %}
        </div>
    </div>

    <!-- Aksi Berdasarkan Peran -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Actions</h5>
            <form method="post">
                {% csrf_token %}
                <div class="form-group mb-3">
                    <label for="message">Message:</label>
                    <textarea name="message" id="message" class="form-control" rows="5"></textarea>
                </div>

                <!-- Aksi untuk Instructor -->
                {% if is_instructor and course.status_course.status == 'draft' %}
                <button type="submit" name="action" value="submit_curation" class="btn btn-primary">Submit for Curation</button>
                {% endif %}

                <!-- Aksi untuk Partner -->
                {% if is_partner and course.status_course.status == 'curation' %}
                <button type="submit" name="action" value="partner_accept" class="btn btn-success">Accept and Submit to Superuser</button>
                <button type="submit" name="action" value="partner_reject" class="btn btn-danger">Reject and Return to Instructor</button>
                {% endif %}

                <!-- Aksi untuk Superuser -->
                {% if is_superuser and course.status_course.status == 'curation' %}
                <button type="submit" name="action" value="superuser_publish" class="btn btn-success">Publish to Catalog</button>
                <button type="submit" name="action" value="superuser_reject" class="btn btn-danger">Reject and Return to Partner</button>
                {% endif %}
            </form>
        </div>
    </div>

    <!-- Tombol Kembali -->
    <a href="#" class="btn btn-secondary mt-3">Back to Catalog</a>
</div>
{% endblock %}
