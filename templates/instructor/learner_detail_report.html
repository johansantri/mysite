{% extends 'home/tes.html' %}
{% load static %}
{% block content %}
    <div class="row justify-content-center">
        <div class="container mt-5">
            <h2 class="mb-4">Learner Detail Report: {{ learner.username }}</h2>
            <p>Instructor: {{ instructor.user.username }}</p>
            <p><strong>Last Login:</strong> {% if last_login %}{{ last_login|date:"Y-m-d H:i:s" }}{% else %}Never logged in{% endif %}</p>
        
            <!-- Export to CSV Button -->
            <a href="?export=true&learner_id={{ learner.id }}" class="btn btn-primary mb-3">Export to CSV</a>
        
            {% if report_data %}
            {% for data in report_data %}
            <div class="card mb-4">
                <div class="card-header">
                    <h4>Course: {{ data.course.course_name }}</h4>
                </div>
                <div class="card-body">
                    <p><strong>Progress:</strong> {{ data.progress_percentage|floatformat:2 }}%</p>
                    <p><strong>Materials Read:</strong> {{ data.materials_read }}/{{ data.total_materials }} ({{ data.materials_read_percentage|floatformat:2 }}%)</p>
                    <p><strong>Assessments Completed:</strong> {{ data.assessments_completed }}/{{ data.total_assessments }} ({{ data.assessments_completed_percentage|floatformat:2 }}%)</p>
                    <p>
                        <strong>Threshold:</strong> {{ data.threshold|floatformat:2 }} 
                        <strong>Total Score:</strong> {{ data.total_score|floatformat:2 }}
                        <strong>Status:</strong> {{ data.status }}
                        {% if data.status == "Pass" %}
                            <span class="text-success">ðŸŽ‰ Congratulations!</span>
                        {% else %}
                            <span class="text-danger">Needs Improvement</span>
                        {% endif %}
                    </p>
        
                    <!-- Material Access Details Table -->
                    <h5>Material Access Details</h5>
                    {% if data.material_access_details %}
                    <table class="table table-striped table-bordered mt-3">
                        <thead class="thead-dark">
                            <tr>
                                <th>Material</th>
                                <th>Access Time</th>
                                <th>Estimated Duration (Minutes)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for material in data.material_access_details %}
                            <tr>
                                <td>{{ material.material_name }}</td>
                                <td>{{ material.access_time|date:"Y-m-d H:i:s" }}</td>
                                <td>
                                    {% if material.duration %}
                                        {{ material.duration|floatformat:2 }}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <p>No materials accessed yet.</p>
                    {% endif %}
        
                    <!-- Assessment Breakdown Table -->
                    <h5>Assessment Breakdown</h5>
                    <table class="table table-striped table-bordered mt-3">
                        <thead class="thead-dark">
                            <tr>
                                <th>Assessment</th>
                                <th>Weight</th>
                                <th>Score</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for assessment in data.assessment_details %}
                            <tr {% if assessment.name == 'Total' %}class="font-weight-bold"{% endif %}>
                                <td>{{ assessment.name }}</td>
                                <td>{{ assessment.weight|floatformat:2 }}</td>
                                <td>{{ assessment.score|floatformat:2 }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
        
                    <!-- AskOra Submissions -->
                    <h5>AskOra Submissions</h5>
                    {% if data.askora_submissions_details %}
                    {% for askora in data.askora_submissions_details %}
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6>{{ askora.assessment_name }}</h6>
                        </div>
                        <div class="card-body">
                            <p><strong>Submission Content:</strong> {{ askora.submission }}</p>
                            <p><strong>Submitted At:</strong> {{ askora.submitted_at|date:"Y-m-d H:i:s" }}</p>
                            <p><strong>Final Score:</strong> {% if askora.final_score %}{{ askora.final_score|floatformat:2 }}{% else %}Not scored yet{% endif %}</p>
        
                            <!-- Peer Reviews -->
                            <h6>Peer Reviews</h6>
                            {% if askora.peer_reviews %}
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>Reviewer</th>
                                        <th>Score</th>
                                        <th>Weight</th>
                                        <th>Comment</th>
                                        <th>Reviewed At</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for review in askora.peer_reviews %}
                                    <tr>
                                        <td>{{ review.reviewer }}</td>
                                        <td>{{ review.score|floatformat:2 }}</td>
                                        <td>{{ review.weight|floatformat:2 }}</td>
                                        <td>{{ review.comment|default:"No comment" }}</td>
                                        <td>{{ review.reviewed_at|date:"Y-m-d H:i:s" }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            {% else %}
                            <p>No peer reviews yet.</p>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <p>No AskOra submissions for this course.</p>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
            {% else %}
            <p class="alert alert-info">This learner is not enrolled in any of your courses, or there is no progress data available.</p>
            {% endif %}
        
            <a href="{% url 'instructor:instructor_learning_report' %}" class="btn btn-secondary mt-3">Back to Main Report</a>
        </div>

    </div>
{% endblock %}