{% extends 'home/base.html' %}
{% load static %}
{% load humanize %}

{% block meta %}
    <!-- Standard Meta Tags -->
    <title>{{ instructor.user.first_name }} {{ instructor.user.last_name }} - Instructor Profile | MyICE</title>
    <meta name="description" content="Learn more about {{ instructor.user.first_name }} {{ instructor.user.last_name }}, an expert instructor at MyICE offering {{ courses_count }} courses with {{ total_participants }} students.">
    <meta name="keywords" content="{{ instructor.user.first_name }}, {{ instructor.user.last_name }}, MyICE, online courses, {{ instructor.user.university|default:'education' }}, {{ instructor.expertise|default:'instructor' }}, instructor profile">
    <meta name="author" content="{{ instructor.user.first_name }} {{ instructor.user.last_name }}">
    <meta name="robots" content="index, follow">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="canonical" href="{{ request.build_absolute_uri }}">

    <!-- Open Graph (OG) Tags for Social Media -->
    <meta property="og:title" content="{{ instructor.user.first_name }} {{ instructor.user.last_name }} - Instructor Profile | MyICE">
    <meta property="og:description" content="{{ instructor.bio|striptags|truncatewords:50|default:'Learn more about '}}{{ instructor.user.first_name }} {{ instructor.user.last_name }}, an expert instructor at MyICE with {{ courses_count }} courses.">
    <meta property="og:type" content="profile">
    <meta property="og:url" content="{{ request.build_absolute_uri }}">
    {% if instructor.user.photo %}
        <meta property="og:image" content="{{ request.scheme }}://{{ request.get_host }}{{ instructor.user.photo.url }}">
    {% else %}
        <meta property="og:image" content="{{ request.scheme }}://{{ request.get_host }}{% static 'images/default-profile.jpg' %}">
    {% endif %}
    <meta property="og:image:alt" content="Profile photo of {{ instructor.user.first_name }} {{ instructor.user.last_name }}">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:site_name" content="MyICE">
    <meta property="og:locale" content="en_US">

    <!-- Twitter Card Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{{ instructor.user.first_name }} {{ instructor.user.last_name }} - Instructor Profile | MyICE">
    <meta name="twitter:description" content="{{ instructor.bio|striptags|truncatewords:50|default:'Learn more about '}}{{ instructor.user.first_name }} {{ instructor.user.last_name }}, an expert instructor at MyICE with {{ courses_count }} courses.">
    {% if instructor.user.photo %}
        <meta name="twitter:image" content="{{ request.scheme }}://{{ request.get_host }}{{ instructor.user.photo.url }}">
    {% else %}
        <meta name="twitter:image" content="{{ request.scheme }}://{{ request.get_host }}{% static 'images/default-profile.jpg' %}">
    {% endif %}
    <meta name="twitter:image:alt" content="Profile photo of {{ instructor.user.first_name }} {{ instructor.user.last_name }}">
    <meta name="twitter:site" content="@MyICE">

    <!-- Additional SEO Meta Tags -->
    <meta name="geo.placename" content="{{ instructor.user.city|default:'Unknown' }}">
    <meta name="geo.region" content="{{ instructor.user.country|default:'Unknown' }}">
    <meta name="language" content="English">
    <meta name="revisit-after" content="7 days">

    <!-- Profile-Specific Meta Tags -->
    <meta property="profile:first_name" content="{{ instructor.user.first_name }}">
    <meta property="profile:last_name" content="{{ instructor.user.last_name }}">
    <meta property="profile:username" content="{{ instructor.user.username }}">
{% endblock %}

{% block content %}
<!-- Instructor Profile Section -->
<section class="py-10 bg-white font-sans">
  <div class="container mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
      
      <!-- Sidebar: Instructor Profile -->
      <div x-data="{ showBio: false }" class="lg:col-span-4 bg-gray-50 border border-gray-200 p-6 rounded-xl shadow">
        <div class="flex justify-center">
          <img loading="lazy"
               width="144"
               height="144"
               src="{% if instructor.user.photo %}{{ instructor.user.photo.url }}{% else %}{% static 'images/default-profile.jpg' %}{% endif %}"
               alt="{{ instructor.user.get_full_name }}'s profile picture"
               class="w-36 h-36 rounded-full object-cover shadow">
        </div>

        <h1 class="text-2xl font-bold text-center mt-4 text-gray-800">{{ instructor.user.first_name }} {{ instructor.user.last_name }}</h1>
        <p class="text-center text-gray-500 text-sm">{{ instructor.user.hobby|default:"No hobby listed" }}</p>

        <!-- University Badge -->
        <div class="text-center mt-4">
          {% if partner_slug %}
            <a href="{% url 'courses:org_partner' partner_slug %}" class="text-xs text-white bg-gray-800 px-3 py-1 rounded shadow hover:bg-gray-700">
              {{ instructor.user.university }} <i class="fas fa-check-circle text-blue-400 text-[13px]" title="Verified"></i>
            </a>
          {% else %}
            <span class="text-xs text-white bg-gray-400 px-3 py-1 rounded shadow">No University</span>
          {% endif %}
        </div>

        <!-- Social Media Icons -->
        <div class="flex justify-center mt-4 space-x-3 text-gray-600 text-lg">
          {% if instructor.user.twitter %}<a href="{{ instructor.user.twitter }}" aria-label="Twitter" target="_blank"><i class="fab fa-twitter"></i></a>{% endif %}
          {% if instructor.user.linkedin %}<a href="{{ instructor.user.linkedin }}" aria-label="LinkedIn" target="_blank"><i class="fab fa-linkedin"></i></a>{% endif %}
          {% if instructor.user.youtube %}<a href="{{ instructor.user.youtube }}" aria-label="YouTube" target="_blank"><i class="fab fa-youtube"></i></a>{% endif %}
          {% if instructor.user.instagram %}<a href="{{ instructor.user.instagram }}" aria-label="Instagram" target="_blank"><i class="fab fa-instagram"></i></a>{% endif %}
          {% if instructor.user.facebook %}<a href="{{ instructor.user.facebook }}" aria-label="Facebook" target="_blank"><i class="fab fa-facebook"></i></a>{% endif %}
          {% if instructor.user.tiktok %}<a href="{{ instructor.user.tiktok }}" aria-label="TikTok" target="_blank"><i class="fab fa-tiktok"></i></a>{% endif %}
          {% if instructor.user.email %}<a href="mailto:{{ instructor.user.email }}" aria-label="Email"><i class="fas fa-envelope"></i></a>{% endif %}
        </div>

        <!-- Stats -->
        <div class="mt-6 space-y-2 text-sm text-gray-700">
          <div class="flex justify-between">
            <span>üë• Students</span>
            <span class="font-semibold">{{ total_participants|default:"0" }}</span>
          </div>
          <div class="flex justify-between">
            <span>‚≠ê Reviews</span>
            <span class="font-semibold">{{ total_reviews|default:"0" }}</span>
          </div>
          <div class="flex justify-between">
            <span>üéì Courses</span>
            <span class="font-semibold">{{ courses_count|default:"0" }}</span>
          </div>
        </div>

        <!-- About Me -->
        <div class="mt-6">
          <h2 class="text-sm font-semibold text-gray-700 uppercase mb-1">About Me</h2>
          <p class="text-sm text-gray-600">
            {{ instructor.bio|truncatechars:100|default:"No bio available" }}
          </p>
          {% if instructor.bio|length > 100 %}
          <button @click="showBio = true" x-show="!showBio" class="text-sm text-blue-500 hover:underline mt-1">Read More</button>
          <p x-show="showBio" x-transition class="text-sm text-gray-600 mt-2">{{ instructor.bio }}</p>
          {% endif %}
        </div>

        <!-- Experience -->
        <div class="mt-6">
          <h2 class="text-sm font-semibold text-gray-700 uppercase mb-1">Experience</h2>
          <p class="text-sm text-gray-600">{{ instructor.experience_years|default:"0" }} years</p>
          <p class="text-sm text-gray-600 mt-1">{{ instructor.expertise|default:"No expertise listed"|safe }}</p>
        </div>
      </div>

      <!-- Course List -->
      <div class="lg:col-span-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Courses by {{ instructor.user.first_name }}</h2>
        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
          {% for course in courses %}
          <div class="bg-white border border-gray-200 rounded-lg overflow-hidden shadow hover:shadow-md transition-transform duration-200 hover:scale-105">
            <div class="relative">
              <img loading="lazy"
                   width="400"
                   height="180"
                   src="{{ course.image|default:'https://via.placeholder.com/400x180' }}"
                   alt="{{ course.course_name }}"
                   class="w-full h-40 object-cover">
              {% if course.is_free %}
                <span class="absolute top-2 left-2 sm:top-3 sm:left-3 bg-green-600 text-white text-sm font-semibold px-3 py-1.5 rounded-md shadow-sm">
                  FREE
                </span>
              {% else %}
                <span class="absolute top-2 left-2 sm:top-3 sm:left-3 bg-green-600 text-white text-sm font-semibold px-3 py-1.5 rounded-md shadow-sm hover:bg-green-700 transition-colors duration-200 truncate max-w-[90%]">
                  IDR {{ course.price|intcomma }}
                  {% if course.discount_amount > 0 %}
                    <span class="line-through text-gray-200 text-xs ml-2">IDR {{ course.normal_price|intcomma }}</span>
                    <span class="absolute -top-2 -right-2 bg-red-500 text-white text-xs font-medium px-2 py-1 rounded-full">
                      Save {{ course.discount_percent }}%
                    </span>
                  {% endif %}
                </span>
              {% endif %}
            </div>
            <div class="p-4">
              <h3 class="font-semibold text-gray-800 text-base truncate">{{ course.course_name }}</h3>
              <p class="text-sm text-gray-500">Ends: {{ course.end_date|default:"N/A" }}</p>
              <p class="text-sm text-gray-500">Enrolled: {{ course.total_enrollments|default:"0" }}</p>
              <div class="flex items-center mt-2">
                {% for _ in course.full_star_range %}
                  <i class="fas fa-star text-yellow-400" aria-hidden="true"></i>
                {% endfor %}
                {% if course.half_star %}
                  <i class="fas fa-star-half-alt text-yellow-400" aria-hidden="true"></i>
                {% endif %}
                {% for _ in course.empty_star_range %}
                  <i class="far fa-star text-gray-400" aria-hidden="true"></i>
                {% endfor %}
                <span class="text-sm text-gray-500 ml-1">({{ course.review_count }})</span>
              </div>
              <a href="{% url 'courses:course_lms_detail' course.id course.slug %}" class="text-sm text-blue-500 hover:underline mt-2 inline-block">View Course</a>
            </div>
          </div>
          {% empty %}
          <p class="text-gray-500 col-span-full">No courses available.</p>
          {% endfor %}
        </div>

        <!-- Pagination -->
        {% if page_obj.has_other_pages %}
        <div class="mt-6 flex justify-center space-x-2">
          {% if page_obj.has_previous %}
          <a href="?page={{ page_obj.previous_page_number }}" class="text-sm px-3 py-1 border rounded hover:bg-gray-200">Previous</a>
          {% endif %}

          {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
              <span class="text-sm px-3 py-1 border rounded bg-gray-800 text-white">{{ num }}</span>
            {% else %}
              <a href="?page={{ num }}" class="text-sm px-3 py-1 border rounded hover:bg-gray-200">{{ num }}</a>
            {% endif %}
          {% endfor %}

          {% if page_obj.has_next %}
          <a href="?page={{ page_obj.next_page_number }}" class="text-sm px-3 py-1 border rounded hover:bg-gray-200">Next</a>
          {% endif %}
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</section>

<!-- Schema Markup -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Person",
  "@id": "{% url 'courses:instructor_profile' username=instructor.user.username %}#instructor",
  "name": "{{ instructor.user.first_name }} {{ instructor.user.last_name }}",
  "jobTitle": "Instructor",
  "affiliation": {
    "@type": "Organization",
    "name": "{{ instructor.user.university|default:'N/A' }}"
  },
  "url": "{% url 'courses:instructor_profile' username=instructor.user.username %}",
  "image": "{% if instructor.user.photo %}{{ instructor.user.photo.url }}{% else %}{% static 'images/default-profile.jpg' %}{% endif %}",
  "sameAs": [
    {% if instructor.user.twitter %}"{{ instructor.user.twitter }}",{% endif %}
    {% if instructor.user.linkedin %}"{{ instructor.user.linkedin }}",{% endif %}
    {% if instructor.user.youtube %}"{{ instructor.user.youtube }}",{% endif %}
    {% if instructor.user.instagram %}"{{ instructor.user.instagram }}"{% endif %}
  ]
}
</script>
{% for course in courses %}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Course",
  "@id": "{% url 'courses:course_lms_detail' course.id course.slug %}#course",
  "name": "{{ course.course_name|default:'Untitled Course'|escapejs }}",
  "description": "{{ course.course_name|truncatechars:100|default:'No description available'|escapejs }}",
  "provider": {
    "@type": "Organization",
    "name": "{{ instructor.user.university|default:'N/A'|escapejs }}"
  },
  "instructor": {
    "@type": "Person",
    "name": "{{ instructor.user.first_name }} {{ instructor.user.last_name }}"
  },
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": "{{ course.avg_rating|floatformat:1 }}",
    "reviewCount": "{{ course.review_count }}"
  },
  "offers": {
    "@type": "Offer",
    "price": "{{ course.price }}",
    "priceCurrency": "IDR"
  },
  "url": "{% url 'courses:course_lms_detail' course.id course.slug %}"
}
</script>
{% endfor %}
{% endblock content %}