{% extends 'home/sos.html' %}
{% load static %}

{% block content %}
<style>
    .tweet-card-post { position: sticky; top: 0; z-index: 100; }
    .main-content { max-height: 100vh; overflow-y: auto; }
    .alert-messages { position: fixed; top: 10px; right: 10px; z-index: 200; }
</style>

<div class="col-md-8 main-content">
    <div id="messages" class="alert-messages" hx-swap-oob="true"></div>
    
    <!-- Form Postingan Utama -->
    <div class="card tweet-card tweet-card-post">
        <div class="card-body">
            <form hx-post="{% url 'courses:create_post' %}" hx-target="#new-posts" hx-swap="prepend">
                {% csrf_token %}
                <textarea name="content" id="id_content" class="form-control" rows="3" placeholder="Apa yang Anda pikirkan?"></textarea>
                <div id="charCount">0/150</div>
                {{ form.captcha }}
                <button type="submit" class="btn btn-primary mt-3">Tweet</button>
            </form>
        </div>
    </div>
    <br>

    <!-- Daftar Postingan -->
    <div id="post-list">
        <div id="new-posts"></div>
        {% for post in posts %}
            {% if not post.parent %}
                {% include 'home/post_item.html' with post=post %}
            {% endif %}
        {% endfor %}
        <div id="loading" style="display: none;">Loading...</div>
        <div id="no-more" style="display: none;">No more posts to load.</div>
    </div>
</div>

<div class="col-md-2 sidebar-right">
    <h5>Pencarian</h5>
    <input type="text" 
           class="form-control mb-3" 
           placeholder="Cari di Twitter..." 
           hx-get="{% url 'courses:search_posts' %}" 
           hx-target="#post-list" 
           hx-swap="innerHTML" 
           hx-trigger="keyup delay:500ms" 
           name="q">
    <h5>Tren</h5>
    <ul class="list-group mb-3">
        {% for trend in trending %}
            <li class="list-group-item">
                <a href="#"
                   hx-get="{% url 'courses:posts_by_hashtag' hashtag=trend.name %}"
                   hx-target="#post-list"
                   hx-swap="innerHTML"
                   onclick="setCurrentHashtag('{{ trend.name }}')">
                    #{{ trend.name }} ({{ trend.count }})
                </a>
            </li>
        {% empty %}
            <li class="list-group-item">Belum ada tren</li>
        {% endfor %}
    </ul>
    
</div>

<script>
    let mainTextarea = document.querySelector('#id_content');
    mainTextarea.addEventListener('input', function() {
        let chars = this.value.length;
        document.getElementById('charCount').innerText = `${chars}/150`;
    });
    document.body.addEventListener('clearForm', function() {
        mainTextarea.value = '';
        document.getElementById('charCount').innerText = '0/150';
        document.querySelectorAll('textarea[name="content"]').forEach(textarea => {
            textarea.value = '';
        });
    });

    let offset = 10;
    let loading = false;
    let currentHashtag = '';
    let currentQuery = '';  // Simpan kata kunci pencarian
    const mainContent = document.querySelector('.main-content');

    function setCurrentHashtag(hashtag) {
        currentHashtag = hashtag;
        currentQuery = '';  // Reset pencarian saat hashtag dipilih
        offset = 10;
        document.getElementById('no-more').style.display = 'none';
    }

    // Setel kata kunci pencarian dari input
    document.querySelector('input[name="q"]').addEventListener('input', function() {
        currentQuery = this.value.trim();
        currentHashtag = '';  // Reset hashtag saat pencarian digunakan
        offset = 10;
        document.getElementById('no-more').style.display = 'none';
    });

    mainContent.addEventListener('scroll', function() {
        if (loading) return;

        const postList = document.getElementById('post-list');
        const loadingDiv = document.getElementById('loading');
        const noMoreDiv = document.getElementById('no-more');
        
        if (mainContent.scrollTop + mainContent.clientHeight >= mainContent.scrollHeight - 100) {
            loading = true;
            loadingDiv.style.display = 'block';
            
            let url = `{% url 'courses:load_more_posts' %}?offset=${offset}`;
            if (currentHashtag) {
                url += `&hashtag=${encodeURIComponent(currentHashtag)}`;
            } else if (currentQuery) {
                url += `&q=${encodeURIComponent(currentQuery)}`;
            }
            
            fetch(url)
                .then(response => response.text())
                .then(html => {
                    loadingDiv.style.display = 'none';
                    if (html.includes('No more posts')) {
                        noMoreDiv.style.display = 'block';
                    } else {
                        postList.insertAdjacentHTML('beforeend', html);
                        offset += 10;
                        loading = false;
                    }
                })
                .catch(error => {
                    console.error('Error loading more posts:', error);
                    loadingDiv.style.display = 'none';
                    loading = false;
                });
        }
    });
</script>
{% endblock content %}