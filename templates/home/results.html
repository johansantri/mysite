{% extends 'home/base.html' %}
{% load static %}

{% block meta %}
  <title>Search Results - LMSKu</title>
  <meta name="description" content="Search results for '{{ query }}' on LMSKu. Find courses, instructors, partners, and articles.">
  <meta property="og:title" content="Search Results - LMSKu">
  <meta property="og:description" content="Search results for '{{ query }}' on LMSKu.">
  <meta property="og:url" content="{{ request.build_absolute_uri }}">
  <meta property="og:type" content="website">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Search Results - LMSKu">
  <meta name="twitter:description" content="Explore search results for '{{ query }}'">

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "LMSKu",
    "url": "{{ request.build_absolute_uri }}",
    "potentialAction": {
      "@type": "SearchAction",
      "target": "{{ request.scheme }}://{{ request.get_host }}{% url 'authentication:search' %}?q={search_term_string}",
      "query-input": "required name=search_term_string"
    }
  }
  </script>

  {% if results.blog_posts %}
  {% for post in results.blog_posts %}
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": "{{ post.title|escapejs }}",
    "image": "{% if post.image %}{{ post.image.url }}{% else %}https://via.placeholder.com/300x180{% endif %}",
    "author": {
      "@type": "Person",
      "name": "{{ post.author.get_full_name|default:post.author.username }}"
    },
    "publisher": {
      "@type": "Organization",
      "name": "LMSKu",
      "logo": {
        "@type": "ImageObject",
        "url": "{{ request.scheme }}://{{ request.get_host }}{% static 'img/logo.png' %}"
      }
    },
    "datePublished": "{{ post.date_posted|date:'c' }}",
    "mainEntityOfPage": "{{ post.get_absolute_url }}"
  }
  </script>
  {% endfor %}
  {% endif %}
{% endblock %}

{% block content %}
<section class="py-10 bg-gray-50">
  <div class="container mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">

    {% if query %}
      <h1 class="text-2xl font-bold text-gray-900 mb-6">Search results for: <span class="text-red-600">{{ query }}</span></h1>
    {% endif %}

    {% if search_history %}
    <section class="mb-8">
      <h2 class="text-xl font-semibold text-red-600 mb-3">Recent Searches</h2>
      <ul class="flex flex-wrap gap-2">
        {% for history in search_history %}
        <li>
          <a href="{% url 'authentication:search' %}?q={{ history|urlencode }}"
             class="px-3 py-1 border border-red-600 text-sm text-red-600 rounded-full hover:bg-red-600 hover:text-white transition">
            {{ history }}
          </a>
        </li>
        {% endfor %}
      </ul>
      {% if user.is_authenticated %}
      <form method="POST" class="mt-3" action="{% url 'authentication:search' %}">
        {% csrf_token %}
        <input type="hidden" name="clear_history" value="1">
        <button type="submit"
                class="px-3 py-1 border border-red-600 text-red-600 rounded-lg text-sm hover:bg-red-600 hover:text-white transition">
          Clear History
        </button>
      </form>
      {% endif %}
    </section>
    {% endif %}

    {% if results.courses %}
    <section>
      <h2 class="text-xl font-bold text-red-600 mb-4">Courses</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        {% for course in results.courses %}
        <div class="bg-white rounded-xl shadow hover:shadow-lg transition h-full">
          {% if course.image %}
          <img src="{{ course.image.url }}" alt="{{ course.course_name }}" loading="lazy"
               class="w-full h-44 object-cover rounded-t-xl hover:scale-105 transition-transform">
          {% else %}
          <img src="https://via.placeholder.com/300x180?text=No+Image" alt="No Image" loading="lazy"
               class="w-full h-44 object-cover rounded-t-xl hover:scale-105 transition-transform">
          {% endif %}
          <div class="p-4">
            <h3 class="text-lg font-semibold text-gray-800">{{ course.course_name }}</h3>
            <p class="text-sm text-gray-600">{{ course.description|truncatewords:20|safe }}</p>
            <a href="{% url 'courses:course_lms_detail' course.id course.slug %}"
               class="inline-block mt-3 text-sm px-3 py-1 border border-red-600 text-red-600 rounded hover:bg-red-600 hover:text-white transition">
              View Course
            </a>
          </div>
        </div>
        {% endfor %}
      </div>
    </section>
    {% endif %}

    {% if results.instructors %}
    <section class="mt-10">
      <h2 class="text-xl font-bold text-red-600 mb-4">Instructors</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        {% for instructor in results.instructors %}
        <div class="text-center p-4 bg-white rounded-xl shadow">
          <img src="{% if instructor.user.photo %}{{ instructor.user.photo.url }}{% else %}https://via.placeholder.com/150?text={{ instructor.user.email|slice:":1" }}{% endif %}"
               alt="{{ instructor.user.email }}" class="w-24 h-24 rounded-full mx-auto border-2 border-red-600 object-cover mb-2">

          <h3 class="font-bold text-gray-900">
            {% if instructor.user.first_name %}
            {{ instructor.user.first_name }} {{ instructor.user.last_name }}
            {% else %}
            {{ instructor.user.email }}
            {% endif %}
          </h3>
          <p class="text-sm text-gray-600">{{ instructor.expertise|truncatewords:20|safe }} â€¢ {{ instructor.experience_years }} years</p>
          <p class="text-sm text-gray-800">{{ instructor.bio|truncatewords:10|safe }}</p>
          <p class="text-red-600 text-xs mt-1"><i class="fas fa-code mr-1"></i>{{ instructor.tech|safe }}</p>
          <p class="text-gray-500 text-xs">Partner: {{ instructor.provider.name.name }}</p>

          {% if instructor.status == 'Approved' %}
          <a href="{% url 'courses:instructor_profile' instructor.user.username %}"
             class="inline-block mt-2 text-sm px-3 py-1 border border-red-600 text-red-600 rounded hover:bg-red-600 hover:text-white transition">
            View Profile
          </a>
          {% endif %}
        </div>
        {% endfor %}
      </div>
    </section>
    {% endif %}

    {% if results.partners %}
    <section class="mt-10">
      <h2 class="text-xl font-bold text-red-600 mb-4">Partners</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        {% for partner in results.partners %}
        <div class="bg-white rounded-xl shadow p-4 hover:shadow-lg transition h-full">
          <h3 class="text-lg font-semibold text-gray-900">{{ partner.partner_name }}</h3>
          <p class="text-sm text-gray-600">{{ partner.description|truncatewords:20|safe }}</p>
          <a href="{% url 'courses:org_partner' partner.name.slug %}"
             class="inline-block mt-2 text-sm px-3 py-1 border border-red-600 text-red-600 rounded hover:bg-red-600 hover:text-white transition">
            See Partner
          </a>
        </div>
        {% endfor %}
      </div>
    </section>
    {% endif %}

    {% if results.blog_posts %}
    <section class="mt-10">
      <h2 class="text-xl font-bold text-red-600 mb-4">Articles</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        {% for post in results.blog_posts %}
        <div class="bg-white rounded-xl shadow hover:shadow-lg transition h-full">
          <img src="{% if post.image %}{{ post.image.url }}{% else %}https://via.placeholder.com/300x180?text=No+Image{% endif %}"
               alt="{{ post.title }}" class="w-full h-44 object-cover rounded-t-xl hover:scale-105 transition-transform">

          <div class="p-4">
            <h3 class="text-lg font-semibold text-gray-900">{{ post.title }}</h3>
            <p class="text-sm text-gray-600">{{ post.content|truncatewords:20|safe }}</p>
            <p class="text-xs text-gray-500">By {{ post.author.username|default:"Unknown" }} on {{ post.date_posted|date:"F d, Y" }}</p>
            {% if post.tags.all %}
            <p class="text-xs text-gray-500">Tags: {% for tag in post.tags.all %}<span class="mr-1">{{ tag.name }}</span>{% endfor %}</p>
            {% endif %}
            <a href="{{ post.get_absolute_url }}"
               class="inline-block mt-3 text-sm px-3 py-1 border border-red-600 text-red-600 rounded hover:bg-red-600 hover:text-white transition">
              Read Article
            </a>
          </div>
        </div>
        {% endfor %}
      </div>

      {% if page_obj.has_other_pages %}
      <nav class="mt-6">
        <ul class="flex justify-center gap-2">
          {% if page_obj.has_previous %}
          <li><a href="?q={{ query|urlencode }}&page={{ page_obj.previous_page_number }}"
                 class="px-3 py-1 border border-red-600 text-red-600 rounded hover:bg-red-600 hover:text-white">Previous</a></li>
          {% endif %}
          {% for num in page_obj.paginator.page_range %}
          <li><a href="?q={{ query|urlencode }}&page={{ num }}"
                 class="px-3 py-1 border {% if page_obj.number == num %}bg-red-600 text-white{% else %}border-red-600 text-red-600{% endif %} rounded hover:bg-red-600 hover:text-white">
              {{ num }}</a></li>
          {% endfor %}
          {% if page_obj.has_next %}
          <li><a href="?q={{ query|urlencode }}&page={{ page_obj.next_page_number }}"
                 class="px-3 py-1 border border-red-600 text-red-600 rounded hover:bg-red-600 hover:text-white">Next</a></li>
          {% endif %}
        </ul>
      </nav>
      {% endif %}
    </section>
    {% endif %}

    {% if not results.courses and not results.instructors and not results.partners and not results.blog_posts and query %}
    <div class="text-center py-12">
      <p class="text-gray-500 text-lg">No results found for "{{ query }}"</p>
      <a href="/" class="mt-4 inline-block px-4 py-2 border border-red-600 text-red-600 rounded hover:bg-red-600 hover:text-white transition">Back to Home</a>
    </div>
    {% endif %}
  </div>
</section>
{% endblock %}
