{% extends 'home/base.html' %}
{% load humanize %}
{% load static %}
{% block meta %}
    <!-- Standard Meta Tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="description" content="{{ course.sort_description|default:'Pelajari kursus menarik ini di LMSKu untuk meningkatkan keterampilan Anda dengan panduan dari instruktur ahli.'|truncatechars:160|safe }}">
    <meta name="keywords" content="{{ course.course_name }}, {{ course.category.name }}, online course, e-learning, LMSKu, {{ course.instructor.user.get_full_name }}, {{ course.get_language_display }}, {{ course.level }}">
    <meta name="author" content="{{ course.instructor.user.get_full_name|default:'LMSKu Team' }}">
    <meta name="robots" content="index, follow">
    <link rel="canonical" content="{{ request.build_absolute_uri }}">

    <!-- Additional SEO Meta Tags -->
    <meta name="geo.placename" content="{{ course.instructor.user.city|default:'Unknown' }}">
    <meta name="geo.region" content="{{ course.instructor.user.country|default:'Unknown' }}">
    <meta name="language" content="{{ course.get_language_display|default:'Indonesian' }}">
    <meta name="revisit-after" content="7 days">

    <!-- Open Graph (OG) Tags for Social Media (Facebook, LinkedIn, WhatsApp) -->
    <meta property="og:title" content="{{ course.course_name }} - LMSKu">
    <meta property="og:description" content="{{ course.sort_description|default:'Pelajari kursus menarik ini di LMSKu untuk meningkatkan keterampilan Anda dengan panduan dari instruktur ahli.'|truncatechars:256|safe }}">
    <meta property="og:type" content="article">
    <meta property="og:url" content="{{ request.build_absolute_uri }}">
    {% if course.image %}
        <meta property="og:image" content="{{ request.scheme }}://{{ request.get_host }}{{ course.image.url }}">
        <meta property="og:image:secure_url" content="{{ request.scheme }}://{{ request.get_host }}{{ course.image.url }}">
    {% else %}
        <meta property="og:image" content="{{ request.scheme }}://{{ request.get_host }}{% static 'assets/img/icon/course-default.jpg' %}">
        <meta property="og:image:secure_url" content="{{ request.scheme }}://{{ request.get_host }}{% static 'assets/img/icon/course-default.jpg' %}">
    {% endif %}
    <meta property="og:image:alt" content="Gambar untuk kursus {{ course.course_name }} di LMSKu">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:site_name" content="LMSKu">
    <meta property="og:locale" content="id_ID">

    <!-- Twitter Card Tags (for X) -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{{ course.course_name }} - LMSKu">
    <meta name="twitter:description" content="{{ course.sort_description|default:'Pelajari kursus menarik ini di LMSKu untuk meningkatkan keterampilan Anda dengan panduan dari instruktur ahli.'|truncatechars:200|safe }}">
    {% if course.image %}
        <meta name="twitter:image" content="{{ request.scheme }}://{{ request.get_host }}{{ course.image.url }}">
        <meta name="twitter:image:src" content="{{ request.scheme }}://{{ request.get_host }}{{ course.image.url }}">
    {% else %}
        <meta name="twitter:image" content="{{ request.scheme }}://{{ request.get_host }}{% static 'assets/img/icon/course-default.jpg' %}">
        <meta name="twitter:image:src" content="{{ request.scheme }}://{{ request.get_host }}{% static 'assets/img/icon/course-default.jpg' %}">
    {% endif %}
    <meta name="twitter:image:alt" content="Gambar untuk kursus {{ course.course_name }} di LMSKu">
    <meta name="twitter:site" content="@LMSKu">
    <meta name="twitter:creator" content="@{{ course.instructor.user.username|default:'LMSKu' }}">

    <!-- Structured Data (JSON-LD) for Course -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Course",
        "name": "{{ course.course_name|safe }}",
        "description": "{{ course.sort_description|default:'Pelajari kursus menarik ini di LMSKu untuk meningkatkan keterampilan Anda dengan panduan dari instruktur ahli.'|truncatechars:256|safe }}",
        "url": "{{ request.build_absolute_uri }}",
        "image": "{% if course.image %}{{ request.scheme }}://{{ request.get_host }}{{ course.image.url }}{% else %}{{ request.scheme }}://{{ request.get_host }}{% static 'assets/img/icon/course-default.jpg' %}{% endif %}",
        "provider": {
            "@type": "Organization",
            "name": "LMSKu",
            "sameAs": "{{ request.scheme }}://{{ request.get_host }}"
        },
        "instructor": {
            "@type": "Person",
            "name": "{{ course.instructor.user.get_full_name|default:'LMSKu Instructor'|safe }}",
            "url": "{% url 'courses:instructor_profile' course.instructor.user.username %}"
        },
        "courseCode": "{{ course.course_number|safe }}",
        "educationalLevel": "{{ course.level|safe }}",
        "inLanguage": "{{ course.get_language_display|safe }}",
        "aggregateRating": {
            "@type": "AggregateRating",
            "ratingValue": "{{ average_rating|default:'0' }}",
            "reviewCount": "{{ reviews.count|default:'0' }}"
        },
        "offers": {
            "@type": "Offer",
            "price": "{% if course.payment_model == 'free' %}0{% else %}{{ course.get_course_price.user_payment|default:'0' }}{% endif %}",
            "priceCurrency": "IDR",
            "availability": "https://schema.org/InStock"
        },
        "hasCourseInstance": {
            "@type": "CourseInstance",
            "courseMode": "online",
            "startDate": "{{ course.start_date|date:'c' }}",
            "endDate": "{{ course.end_date|date:'c' }}"
        }
    }
    </script>

    <!-- Structured Data for Breadcrumb -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BreadcrumbList",
        "itemListElement": [
            {
                "@type": "ListItem",
                "position": 1,
                "name": "Home",
                "item": "{{ request.scheme }}://{{ request.get_host }}"
            },
            {
                "@type": "ListItem",
                "position": 2,
                "name": "{{ course.category.name|safe }}",
                "item": "{% url 'courses:category_list' course.category.slug %}"
            },
            {
                "@type": "ListItem",
                "position": 3,
                "name": "{{ course.course_name|safe }}",
                "item": "{{ request.build_absolute_uri }}"
            }
        ]
    }
    </script>

    <!-- Favicon and App Icons -->
    <link rel="icon" href="{% static 'assets/img/icon/course-default.jpg' %}" type="image/jpeg">
    <link rel="apple-touch-icon" href="{% static 'assets/img/icon/apple-touch-icon.png' %}">

    <!-- Security and Performance -->
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
{% endblock %}
{% block content %}

<!-- Course Content Section -->
<section class="py-8 bg-white font-sans">
    <div class="container mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Main Content -->
            <div class="lg:col-span-2">
                <!-- Overview -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <!-- Inner Banner -->
                    <div class="bg-gray-100 border border-gray-200 rounded-xl p-6 mb-6">
                        <h2 class="text-2xl font-bold text-gray-900 mb-3">{{ course.course_name }}</h2>
                        <a href="{% url 'courses:category_list' course.category.slug %}" class="inline-block">
                            <span class="inline-block bg-red-500 text-white text-sm font-medium px-3 py-1 rounded-md mb-3">{{ course.category }}</span>
                        </a>
                        <p class="text-gray-600 mb-4">{{ course.sort_description }}</p>
                        <div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm flex flex-wrap gap-4">
                            <div class="flex items-center">
                                <i class="fas fa-book text-red-500 mr-2"></i>
                                <span class="font-medium">{{ total_sections }} Lessons</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-clock text-red-500 mr-2"></i>
                                <span class="font-medium">{{ total_effort_hours }}hr</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-users text-red-500 mr-2"></i>
                                <span class="font-medium">{{ total_students }} Students </span>
                               
                            </div>

                           <div class="flex items-center">
                                <svg class="w-5 h-5 text-red-500 mr-2" fill="none" stroke="currentColor" stroke-width="1.5"
                                    viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7
                                            -1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                                <span class="font-medium">{{ course.view_count }}</span>
                            </div>

                            <div class="flex items-center">
                                <div class="flex">
                                    {% for i in full_star_range %}
                                        <i class="fas fa-star text-yellow-400"></i>
                                    {% endfor %}
                                    {% if half_star %}
                                        <i class="fas fa-star-half-alt text-yellow-400"></i>
                                    {% endif %}
                                    {% for i in empty_star_range %}
                                        <i class="far fa-star text-gray-400"></i>
                                    {% endfor %}
                                </div>
                                <span class="font-medium ml-2">{{ average_rating }} Rating</span>
                            </div>
                        </div>
                    </div>
                    <h5 class="text-lg font-bold text-gray-900 mb-3">Overview</h5>
                    

                    
                    <div 
                            x-data="{ expanded: false }" 
                            class="relative bg-white rounded-xl shadow-sm border p-4 mb-6"
                        >
                            

                            <div 
                                :class="expanded ? '' : 'line-clamp-4'" 
                                class="text-gray-600 text-sm leading-relaxed transition-all duration-300 ease-in-out"
                            >
                                {{ course.description|safe }}
                            </div>

                            <button 
                                @click="expanded = !expanded" 
                                class="mt-3 text-sm font-medium text-red-600 hover:underline focus:outline-none"
                                x-text="expanded ? 'Show less' : 'Read more'"
                            ></button>
                        </div>

                </div>

                <!-- Course Content -->
                <div class="bg-white rounded-xl shadow-md mt-6 p-6">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                        <h5 class="text-xl font-bold text-gray-900">Course Content</h5>
                        <h6 class="text-gray-500 text-sm mt-2 md:mt-0">Note</h6>
                    </div>
                    <div id="courseAccordion">
                        {% for i in section_data %}
                        {% if not i.children.all %}
                            <div class="bg-blue-100 text-blue-800 p-4 rounded-xl text-sm mb-4">
                            No sections available yet.
                            </div>
                        {% else %}
                            {% for obj in i.children.all %}
                            <details class="rounded-xl mb-4 shadow-sm bg-gray-50 group">
                                <summary class="cursor-pointer border-b border-gray-200 w-full flex justify-between items-center px-4 py-3 font-semibold text-gray-800 bg-gray-100 rounded-t-xl hover:bg-red-500 hover:text-white transition-colors">
                                <span>{{ obj.title }}</span>
                                <svg class="w-4 h-4 ml-2 transition-transform duration-300 text-gray-500 group-open:rotate-180" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                                </svg>
                                </summary>
                                <div class="px-4 py-3">
                                <ul class="space-y-3">
                                    {% if not obj.children.all %}
                                    {% for material in obj.materials.all %}
                                        <li class="flex justify-between items-center border-b border-gray-200 pb-2">
                                        <p class="text-sm text-gray-700">
                                            <i class="fas fa-file text-red-500 mr-2"></i>{{ material.title }}
                                        </p>
                                        <div class="text-sm text-gray-500">{{ material.duration }}</div>
                                        </li>
                                    {% empty %}
                                        <li class="text-gray-400 text-sm">No materials available.</li>
                                    {% endfor %}
                                    {% for assesment in obj.assessments.all %}
                                        <li class="flex justify-between items-center border-b border-gray-200 pb-2">
                                        <p class="text-sm text-gray-700">
                                            <i class="fas fa-check text-red-500 mr-2"></i>{{ assesment.name | safe }}
                                        </p>
                                        <span class="bg-red-500 text-white text-xs font-semibold px-3 py-1 rounded-full">{{ assesment.weight }}%</span>
                                        </li>
                                    {% empty %}
                                        <li class="text-gray-400 text-sm">No assessments available.</li>
                                    {% endfor %}
                                    {% else %}
                                    {% for subobj in obj.children.all %}
                                        <li class="border-b border-gray-200 pb-2">
                                        <p class="text-sm text-gray-700">
                                            <i class="fas fa-play-circle text-red-500 mr-2"></i>A.1.1 {{ subobj.title }}
                                        </p>
                                        </li>
                                    {% endfor %}
                                    <div class="mt-4 flex gap-3">
                                        <a href="javascript:void(0);" class="bg-red-500 text-white text-sm font-medium px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">Add Article</a>
                                        <a href="javascript:void(0);" class="border border-gray-300 text-sm text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors">Add Description</a>
                                    </div>
                                    {% endif %}
                                </ul>
                                </div>
                            </details>
                            {% endfor %}
                        {% endif %}
                        {% endfor %}
                    </div>
                    </div>


                <!-- Similar Courses -->
                <div class="mt-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-4 sm:px-3">Similar Courses with <strong>{{ course.instructor.user.first_name }}</strong></h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                        {% for similar_course in similar_courses %}
                            <div>
                                <div class="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-lg transition-shadow">
                                    {% if similar_course.image %}
                                        <a href="{% url 'courses:course_lms_detail' similar_course.id similar_course.slug %}">
                                            <img src="{{ similar_course.image.url }}" class="w-full h-30 object-cover sm:h-30" alt="{{ similar_course.course_name }}">
                                        </a>
                                    {% else %}
                                        <img src="https://via.placeholder.com/150" class="w-full h-40 object-cover sm:h-36" alt="No Image">
                                    {% endif %}
                                    <div class="p-4">
                                        <h5 class="text-lg font-semibold">
                                            <a href="{% url 'courses:course_lms_detail' similar_course.id similar_course.slug %}" class="text-gray-900 hover:text-red-500 transition-colors">
                                                {{ similar_course.course_name }}
                                            </a>
                                        </h5>
                                    </div>
                                </div>
                            </div>
                        {% empty %}
                            <div class="col-span-full">
                                <div class="bg-yellow-100 text-yellow-800 rounded-xl p-4 text-center sm:px-3">No similar courses available.</div>
                            </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Instructor -->
                <div class="bg-white rounded-xl shadow-md p-6 mt-6">
                    <h5 class="text-lg font-bold text-gray-900 mb-4">About the Instructor</h5>
                    <div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm mb-4 flex flex-wrap items-center gap-4">
                        <div class="flex items-center">
                            <div class="mr-3">
                                {% if course.instructor.user.photo %}
                                    <a href="{% url 'courses:instructor_profile' course.instructor.user.username %}">
                                        <img src="{{ course.instructor.user.photo.url }}" alt="Instructor" class="w-16 h-16 object-cover rounded-full border">
                                    </a>
                                {% else %}
                                    <a href="{% url 'courses:instructor_profile' course.instructor.user.username %}">
                                        <img src="{% static 'assets/img/user/user1.jpg' %}" alt="Instructor" class="w-16 h-16 object-cover rounded-full border">
                                    </a>
                                {% endif %}
                            </div>
                            <div>
                                <h5 class="text-md font-bold">
                                    <a href="{% url 'courses:instructor_profile' course.instructor.user.username %}" class="text-gray-900 hover:text-red-500 transition-colors">{{ course.instructor.user.first_name }} {{ course.instructor.user.last_name }}</a>
                                </h5>
                                <p class="text-gray-600 mb-0">{{ course.instructor.user.hobby }}</p>
                            </div>
                        </div>
                        <div class="ml-auto flex items-center">
                            <div class="flex">
                                <i class="fas fa-star text-yellow-400"></i>
                                <i class="fas fa-star text-yellow-400"></i>
                                <i class="fas fa-star text-yellow-400"></i>
                                <i class="fas fa-star text-yellow-400"></i>
                                <i class="fas fa-star text-gray-400"></i>
                            </div>
                            <span class="font-bold ml-1">4.5</span>
                        </div>
                    </div>
                    <div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm mb-4 flex flex-wrap gap-4">
                        <div class="flex items-center">
                            <i class="fas fa-play-circle text-red-500 mr-2"></i>
                            <span class="font-medium">{{ instructor_total_courses }} Courses</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-book text-red-500 mr-2"></i>
                            <span class="font-medium">{{ instructor_total_sections }} Sections </span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-clock text-red-500 mr-2"></i>
                            <span class="font-medium">{{ instructor_total_effort_hours }} Hours</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-users text-red-500 mr-2"></i>
                            <span class="font-medium">{{ instructor_total_students }} Students</span>
                        </div>
                    </div>
                    <p class="text-gray-600">{{ course.instructor.bio }}</p>
                </div>

                <!-- Reviews -->
                <div class="bg-white rounded-xl shadow-md p-6 mt-6">
                    <h5 class="text-lg font-bold text-gray-900 mb-4">Reviews</h5>
                    {% for review in reviews %}
                        <div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm mb-4 flex flex-wrap items-center gap-4">
                            <div class="flex items-center">
                                <div class="mr-3">
                                    <a href="{% url 'learner:learner_detail' review.user.username %}" target="_blank">
                                        {% if review.user.photo %}
                                            <img src="{{ review.user.photo.url }}" alt="Reviewer" class="w-16 h-16 object-cover rounded-full border">
                                        {% else %}
                                            <img src="{% static 'images/default_profile.png' %}" alt="Reviewer" class="w-16 h-16 object-cover rounded-full border">
                                        {% endif %}
                                    </a>
                                </div>
                                <div>
                                    <h5 class="text-md font-bold">
                                        <a href="{% url 'learner:learner_detail' review.user.username %}" target="_blank" class="text-gray-900 hover:text-red-500 transition-colors">{{ review.user.username }}</a>
                                    </h5>
                                    <p class="text-gray-600 mb-0">{{ review.user.get_full_name }}</p>
                                </div>
                            </div>
                            <div class="ml-auto flex items-center">
                                {% for i in range %}
                                    <i class="fas fa-star {% if i <= review.rating %}text-yellow-400{% else %}text-gray-400{% endif %}"></i>
                                {% endfor %}
                                <span class="font-bold ml-1">{{ review.rating }}</span>
                            </div>
                        </div>
                        <p class="text-gray-600 mb-3">“{{ review.comment }}”</p>
                    {% empty %}
                        <p class="text-gray-600">Belum ada review untuk kursus ini.</p>
                    {% endfor %}
                    <ul class="flex justify-center gap-2 mt-4">
                        {% if reviews.has_previous %}
                            <li>
                                <a class="px-3 py-1 rounded-md shadow-sm text-red-500 border border-gray-200 hover:bg-red-500 hover:text-white transition-colors" href="?page=1" aria-label="First">
                                    <i class="fas fa-angle-double-left"></i>
                                </a>
                            </li>
                            <li>
                                <a class="px-3 py-1 rounded-md shadow-sm text-red-500 border border-gray-200 hover:bg-red-500 hover:text-white transition-colors" href="?page={{ reviews.previous_page_number }}" aria-label="Previous">
                                    <i class="fas fa-angle-left"></i>
                                </a>
                            </li>
                        {% else %}
                            <li class="opacity-50">
                                <span class="px-3 py-1 rounded-md shadow-sm text-gray-400 border border-gray-200"><i class="fas fa-angle-double-left"></i></span>
                            </li>
                            <li class="opacity-50">
                                <span class="px-3 py-1 rounded-md shadow-sm text-gray-400 border border-gray-200"><i class="fas fa-angle-left"></i></span>
                            </li>
                        {% endif %}
                        <li>
                            <span class="bg-red-500 text-white px-4 py-1 rounded-md shadow-sm">
                                {{ reviews.number }} of {{ reviews.paginator.num_pages }}
                            </span>
                        </li>
                        {% if reviews.has_next %}
                            <li>
                                <a class="px-3 py-1 rounded-md shadow-sm text-red-500 border border-gray-200 hover:bg-red-500 hover:text-white transition-colors" href="?page={{ reviews.next_page_number }}" aria-label="Next">
                                    <i class="fas fa-angle-right"></i>
                                </a>
                            </li>
                            <li>
                                <a class="px-3 py-1 rounded-md shadow-sm text-red-500 border border-gray-200 hover:bg-red-500 hover:text-white transition-colors" href="?page={{ reviews.paginator.num_pages }}" aria-label="Last">
                                    <i class="fas fa-angle-double-right"></i>
                                </a>
                            </li>
                        {% else %}
                            <li class="opacity-50">
                                <span class="px-3 py-1 rounded-md shadow-sm text-gray-400 border border-gray-200"><i class="fas fa-angle-right"></i></span>
                            </li>
                            <li class="opacity-50">
                                <span class="px-3 py-1 rounded-md shadow-sm text-gray-400 border border-gray-200"><i class="fas fa-angle-double-right"></i></span>
                            </li>
                        {% endif %}
                    </ul>
                </div>

                <!-- Comment Section -->
                <div class="bg-white rounded-xl shadow-md p-6 mt-6">
                    <h5 class="text-lg font-bold text-gray-900 mb-4">Post a Comment</h5>
                    <form method="POST" action="{% url 'courses:add_comment_course' course_id=course.id %}">
                        {% csrf_token %}
                        
                        <div class="mb-3">
                            <textarea name="content" rows="4" class="w-full border border-gray-200 rounded-xl shadow-sm p-3 focus:border-red-500 focus:ring focus:ring-red-100 transition-colors" placeholder="Your Comments" required></textarea>
                        </div>
                        <input type="hidden" name="parent_id" value="">
                        <button type="submit" class="border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors">Submit</button>
                    </form>
                </div>

                <!-- Comments -->
                <div class="mt-6">
                    {% for comment in comments %}
                        <div class="bg-white border border-gray-200 rounded-xl p-4 mb-3 shadow-sm hover:shadow-md transition-shadow">
                            <p class="mb-1">
                                <strong class="text-gray-900">{{ comment.user.username }}</strong>
                                <small class="text-gray-600">{{ comment.created_at|date:"F j, Y, g:i a" }}</small>
                            </p>
                            <p class="text-gray-600 mb-2">{{ comment.content }}</p>
                            <div class="text-right">
                                <button class="text-red-500 hover:text-red-600 font-bold text-sm underline" onclick="toggleReplyForm('comment-reply-form-{{ comment.id }}')">
                                    <i class="bi bi-reply-fill mr-1"></i>Reply
                                </button>
                            </div>
                            <div id="comment-reply-form-{{ comment.id }}" class="hidden mt-3">
                                <form method="POST" action="{% url 'courses:add_comment_course' course_id=course.id %}">
                                    {% csrf_token %}
                                    <div class="flex gap-2 mb-2">
                                        <textarea name="content" class="w-full border border-gray-200 rounded-xl shadow-sm p-3 focus:border-red-500 focus:ring focus:ring-red-100 transition-colors" rows="2" placeholder="Reply to this comment..." required></textarea>
                                        <input type="hidden" name="parent_id" value="{{ comment.id }}">
                                        <button type="submit" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">Reply</button>
                                    </div>
                                </form>
                            </div>
                            <div class="ml-6">
                                {% for reply in comment.replies.all %}
                                    <div class="bg-gray-50 border border-gray-200 rounded-xl p-4 mt-3 shadow-sm">
                                        <p class="mb-1">
                                            <strong class="text-gray-900">{{ reply.user.username }}</strong>
                                            <small class="text-gray-600">{{ reply.created_at|date:"F j, Y, g:i a" }}</small>
                                        </p>
                                        <p class="text-gray-600 mb-2">{{ reply.content }}</p>
                                        <div class="text-right">
                                            <button class="text-red-500 hover:text-red-600 font-bold text-sm underline" onclick="toggleReplyForm('reply-form-{{ reply.id }}')">
                                                <i class="bi bi-reply-fill mr-1"></i>Reply
                                            </button>
                                        </div>
                                        <div id="reply-form-{{ reply.id }}" class="hidden mt-3">
                                            <form method="POST" action="{% url 'courses:add_comment_course' course_id=course.id %}">
                                                {% csrf_token %}
                                                <div class="flex gap-2 mb-2">
                                                    <textarea name="content" class="w-full border border-gray-200 rounded-xl shadow-sm p-3 focus:border-red-500 focus:ring focus:ring-red-100 transition-colors" rows="2" placeholder="Reply to this comment..." required></textarea>
                                                    <input type="hidden" name="parent_id" value="{{ reply.id }}">
                                                    <button type="submit" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">Reply</button>
                                                </div>
                                            </form>
                                        </div>
                                        <div class="ml-6">
                                            {% for sub_reply in reply.replies.all %}
                                                <div class="bg-gray-100 border border-gray-200 rounded-xl p-4 mt-3 shadow-sm">
                                                    <p class="mb-1">
                                                        <strong class="text-gray-900">{{ sub_reply.user.username }}</strong>
                                                        <small class="text-gray-600">{{ sub_reply.created_at|date:"F j, Y, g:i a" }}</small>
                                                    </p>
                                                    <p class="text-gray-600 mb-2">{{ sub_reply.content }}</p>
                                                    <div class="text-right">
                                                        <button class="text-red-500 hover:text-red-600 font-bold text-sm underline" onclick="toggleReplyForm('sub-reply-form-{{ sub_reply.id }}')">
                                                            <i class="bi bi-reply-fill mr-1"></i>Reply
                                                        </button>
                                                    </div>
                                                    <div id="sub-reply-form-{{ sub_reply.id }}" class="hidden mt-3">
                                                        <form method="POST" action="{% url 'courses:add_comment_course' course_id=course.id %}">
                                                            {% csrf_token %}
                                                            <div class="flex gap-2 mb-2">
                                                                <textarea name="content" class="w-full border border-gray-200 rounded-xl shadow-sm p-3 focus:border-red-500 focus:ring focus:ring-red-100 transition-colors" rows="2" placeholder="Reply to this sub-reply..." required></textarea>
                                                                <input type="hidden" name="parent_id" value="{{ sub_reply.id }}">
                                                                <button type="submit" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">Reply</button>
                                                            </div>
                                                        </form>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% empty %}
                        <p class="text-gray-600">No comments yet. Be the first to comment!</p>
                    {% endfor %}
                </div>
            </div>

            <!-- Sidebar -->
            <div class="lg:col-span-1">
                <div class="sticky top-20 z-10">
                    <!-- Video -->
                    <div class="mb-6">
                        <div class="bg-white rounded-xl shadow-md p-6">
                            <div class="relative mb-4">
                                {% if course.link_video %}
                                    <a href="{{ course.link_video }}" class="block" data-fancybox="video-gallery">
                                        {% if course.image %}
                                            <img src="{{ course.image.url }}" alt="{{ course.name }} Image" class="w-full h-40 object-cover rounded-xl hover:scale-105 transition-transform">
                                        {% else %}
                                            <img src="{% static 'assets/img/user/logo.5272a797c07c.png' %}" alt="Default Image" class="w-full h-52 object-cover rounded-xl hover:scale-105 transition-transform">
                                        {% endif %}
                                        <div class="absolute inset-0 flex items-center justify-center bg-red-500 bg-opacity-75 rounded-full w-16 h-16 transform -translate-x-1/2 -translate-y-1/2 left-1/2 top-1/2">
                                            <i class="fas fa-play text-white text-2xl"></i>
                                        </div>
                                    </a>
                                {% else %}
                                    <a href="https://www.youtube.com/watch?v=nc6m9WM3Gyw&t=1s" class="block" data-fancybox="video-gallery">
                                        <img src="{% static 'assets/img/user/logo.5272a797c07c.png' %}" alt="Default Image" class="w-full h-52 object-cover rounded-xl hover:scale-105 transition-transform">
                                        <div class="absolute inset-0 flex items-center justify-center bg-red-500 bg-opacity-75 rounded-full w-16 h-16 transform -translate-x-1/2 -translate-y-1/2 left-1/2 top-1/2">
                                            <i class="fas fa-play text-white text-2xl"></i>
                                        </div>
                                    </a>
                                {% endif %}
                            </div>
                            <div class="text-center">
                               {% with course_price=course.get_course_price %}
                                    <div class="mb-4">
                                        {% if course_price %}
                                            <h2 class="text-2xl font-bold text-gray-900 mb-1">
                                                {% if course.payment_model == 'free' %}
                                                    Free
                                                {% else %}
                                                    IDR {{ course_price.user_payment|intcomma }}
                                                {% endif %}
                                            </h2>

                                            {% if course.payment_model == 'pay_for_exam' %}
                                                <div class="bg-blue-50 text-blue-800 p-3 rounded-lg">
                                                <p class="text-red-600 mb-0">Free to enroll, pay only when taking the exam</p>
                                                </div>
                                            {% elif course.payment_model == 'pay_for_certificate' %}
                                                <div class="bg-blue-50 text-blue-800 p-3 rounded-lg">
                                                <p class="text-red-600 mb-0">Free to enroll and take the exam, pay only when claiming certificate</p>
                                                </div>
                                                {% if course_price.discount_percent > 0 %}
                                                    <p class="text-gray-600 mb-0">
                                                        <span class="line-through">IDR {{ course_price.normal_price|intcomma }}</span>
                                                        <span class="inline-block bg-red-500 text-white text-sm font-medium px-3 py-1 rounded-md">{{ course_price.discount_percent }}% off</span>
                                                    </p>
                                                {% endif %}
                                            {% elif course.payment_model == 'buy_first' %}
                                                {% if course_price.discount_percent > 0 %}
                                                    <p class="text-gray-600 mb-0">
                                                        <span class="line-through">IDR {{ course_price.normal_price|intcomma }}</span>
                                                        <span class="inline-block bg-red-500 text-white text-sm font-medium px-3 py-1 rounded-md">{{ course_price.discount_percent }}% off</span>
                                                    </p>
                                                {% endif %}
                                                <div class="bg-blue-50 text-blue-800 p-3 rounded-lg">
                                                <p class="text-red-600 mb-0">Payment required before enrollment</p>
                                                </div>
                                            {% endif %}
                                        {% else %}
                                            <h2 class="text-2xl font-bold text-gray-900 mb-1">Price not available</h2>
                                            <p class="text-gray-600 mb-0">Please contact support to set up pricing for this course.</p>
                                        {% endif %}
                                    </div>
                                    {% endwith %}


                               <div class="flex flex-col gap-2 sm:gap-3 mb-4">
                                <!-- Baris Atas: Wishlist, WhatsApp, Facebook -->
                                <div class="flex flex-wrap justify-center gap-2 sm:gap-3">
                                    <!-- Wishlist -->
                                    <a href="#" 
                                    class="flex items-center justify-center border border-red-500 text-red-500 px-2 py-2 sm:px-3 sm:py-2 rounded-lg hover:bg-red-500 hover:text-white transition-colors w-full sm:w-24"
                                    aria-label="Add to Wishlist">
                                        <i class="fas fa-heart text-sm sm:text-base mr-1"></i>
                                        <span class="text-xs sm:text-sm"></span>
                                    </a>
                                    <!-- WhatsApp Share -->
                                    <a href="https://api.whatsapp.com/send?text={{ course.course_name|urlencode }}%0A{{ course.sort_description|default:'Pelajari kursus menarik ini di LMSKu!'|truncatechars:200|urlencode }}%0A{{ request.build_absolute_uri|urlencode }}"
                                    class="flex items-center justify-center border border-gray-300 text-gray-700 px-2 py-2 sm:px-3 sm:py-2 rounded-lg hover:bg-gray-100 transition-colors w-full sm:w-24"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    aria-label="Share on WhatsApp">
                                        <i class="fab fa-whatsapp text-green-500 text-sm sm:text-base mr-1"></i>
                                        <span class="text-xs sm:text-sm"></span>
                                    </a>
                                    <!-- Facebook Share -->
                                    <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri|urlencode }}"
                                    class="flex items-center justify-center border border-gray-300 text-gray-700 px-2 py-2 sm:px-3 sm:py-2 rounded-lg hover:bg-gray-100 transition-colors w-full sm:w-24"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    aria-label="Share on Facebook">
                                        <i class="fab fa-facebook-f text-blue-600 text-sm sm:text-base mr-1"></i>
                                        <span class="text-xs sm:text-sm"></span>
                                    </a>
                                </div>
                                <!-- Baris Bawah: LinkedIn, X, Instagram -->
                                <div class="flex flex-wrap justify-center gap-2 sm:gap-3">
                                    <!-- LinkedIn Share -->
                                    <a href="https://www.linkedin.com/shareArticle?mini=true&url={{ request.build_absolute_uri|urlencode }}&title={{ course.course_name|urlencode }}&summary={{ course.sort_description|default:'Pelajari kursus menarik ini di LMSKu untuk meningkatkan keterampilan Anda dengan panduan dari instruktur ahli.'|truncatechars:256|urlencode }}&source={{ request.scheme }}://{{ request.get_host }}"
                                    class="flex items-center justify-center border border-gray-300 text-gray-700 px-2 py-2 sm:px-3 sm:py-2 rounded-lg hover:bg-gray-100 transition-colors w-full sm:w-24"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    aria-label="Share on LinkedIn">
                                        <i class="fab fa-linkedin-in text-blue-700 text-sm sm:text-base mr-1"></i>
                                        <span class="text-xs sm:text-sm"></span>
                                    </a>
                                    <!-- X Share -->
                                    <a href="https://x.com/intent/tweet?url={{ request.build_absolute_uri|urlencode }}&text={{ course.course_name|urlencode }}%20-%20{{ course.sort_description|default:'Pelajari kursus menarik ini di LMSKu!'|truncatechars:200|urlencode }}"
                                    class="flex items-center justify-center border border-gray-300 text-gray-700 px-2 py-2 sm:px-3 sm:py-2 rounded-lg hover:bg-gray-100 transition-colors w-full sm:w-24"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    aria-label="Share on X">
                                        <i class="fab fa-x-twitter text-black text-sm sm:text-base mr-1"></i>
                                        <span class="text-xs sm:text-sm"></span>
                                    </a>
                                    <!-- Instagram Share -->
                                    <button onclick="copyToClipboard('{{ request.build_absolute_uri }}')"
                                            class="flex items-center justify-center border border-gray-300 text-gray-700 px-2 py-2 sm:px-3 sm:py-2 rounded-lg hover:bg-gray-100 transition-colors w-full sm:w-24"
                                            aria-label="Copy link for your share">
                                        <i class="fas fa-share-alt text-gray-600 text-sm sm:text-base mr-1"></i>

                                        <span class="text-xs sm:text-sm"></span>
                                    </button>
                                </div>
                            </div>
                            <script>
                            function copyToClipboard(url) {
                                navigator.clipboard.writeText(url).then(() => {
                                    alert('Link copied to clipboard! Paste it anywhere to share.');
                                }).catch(err => {
                                    console.error('Failed to copy: ', err);
                                    alert('Failed to copy link. Please copy the URL manually.');
                                });
                            }
                            </script>
                                {% for message in messages %}
                                    <div class="bg-{{ message.tags }}-100 text-{{ message.tags }}-800 p-4 rounded-xl mb-4 relative">
                                        {{ message }}
                                        <button type="button" class="absolute top-2 right-2 text-{{ message.tags }}-800" data-bs-dismiss="alert" aria-label="Close">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                {% endfor %}
                               {% if request.user.is_authenticated %}
                                    {% if is_enrolled %}
                                        <a href="{% url 'learner:course_learn' request.user.username course.id course.slug %}" class="block bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">Start Course</a>
                                    {% else %}
                                        {% with course_price=course.get_course_price %}
                                            {% if course.payment_model == 'free' or course.payment_model == 'pay_for_exam' or course.payment_model == 'pay_for_certificate' %}
                                                <form id="enrollForm" method="POST" action="{% url 'courses:enroll' course.id %}">
                                                    {% csrf_token %}
                                                    <button type="submit" class="block w-full bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">Enroll Now</button>
                                                </form>
                                            {% else %}
                                                <form method="POST" action="{% url 'payments:add_to_cart' course.id %}">
                                                    {% csrf_token %}
                                                    <button type="submit" class="block w-full bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">Add to Cart</button>
                                                </form>
                                            {% endif %}
                                        {% endwith %}
                                    {% endif %}
                                {% else %}
                                    <a href="{% url 'authentication:register' %}?next={% url 'courses:course_lms_detail' id=course.id slug=course.slug %}" class="block bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">Join Now</a>
                                {% endif %}

                            </div>
                        </div>
                    </div>
                    <!-- Features -->
                    <div class="bg-white rounded-xl shadow-md p-6">
                        <h4 class="text-xl font-bold text-gray-900 mb-3">Includes</h4>
                        <ul class="list-none">
                            <li class="flex justify-between items-center py-2 border-b border-gray-200">
                                <span class="font-medium text-gray-900">Course Number:</span>
                                <span class="text-gray-600">{{ course.course_number }}</span>
                            </li>
                            <li class="flex justify-between items-center py-2 border-b border-gray-200">
                                <span class="font-medium text-gray-900">Class Run:</span>
                                <span class="text-gray-600">{{ course.course_run }}</span>
                            </li>
                            <li class="flex justify-between items-center py-2 border-b border-gray-200">
                                <span class="font-medium text-gray-900">Class Start:</span>
                                <span class="text-gray-600">{{ course.start_date }}</span>
                            </li>
                            <li class="flex justify-between items-center py-2 border-b border-gray-200">
                                <span class="font-medium text-gray-900">Class End:</span>
                                <span class="text-gray-600">{{ course.end_date }}</span>
                            </li>
                            <li class="flex justify-between items-center py-2 border-b border-gray-200">
                                <span class="font-medium text-gray-900">Enroll Start:</span>
                                <span class="text-gray-600">{{ course.start_enrol }}</span>
                            </li>
                            <li class="flex justify-between items-center py-2 border-b border-gray-200">
                                <span class="font-medium text-gray-900">Enroll End:</span>
                                <span class="text-gray-600">{{ course.end_enrol }}</span>
                            </li>
                            <li class="flex justify-between items-center py-2 border-b border-gray-200">
                                <span class="font-medium text-gray-900">Hours Effort:</span>
                                <span class="text-gray-600">{{ course.hour }}</span>
                            </li>
                            <li class="flex justify-between items-center py-2 border-b border-gray-200">
                                <span class="font-medium text-gray-900">Language:</span>
                                <span class="text-gray-600">{{ course.get_language_display }}</span>
                            </li>
                            <li class="flex justify-between items-center py-2">
                                <span class="font-medium text-gray-900">Level:</span>
                                <span class="text-gray-600">{{ course.level }}</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>





{% endblock %}