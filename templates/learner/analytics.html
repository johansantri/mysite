{% extends 'home/tes.html' %}
{% load static %}
{% block content %}

  <h1 class="mb-4 fw-bold h3 text-primary">User Analytics Dashboard</h1>

  <!-- Filter & Download -->
  <form method="get" class="row g-2 mb-4">
    <div class="col-md-3">
      <select name="gender" class="form-select">
        <option value="">All Genders</option>
        <option value="male" {% if gender_filter == "male" %}selected{% endif %}>Male</option>
        <option value="female" {% if gender_filter == "female" %}selected{% endif %}>Female</option>
      </select>
    </div>
    <div class="col-md-3">
      <input type="date" name="start_date" class="form-control" placeholder="Start Date" value="{{ start_date }}">
    </div>
    <div class="col-md-3">
      <input type="date" name="end_date" class="form-control" placeholder="End Date" value="{{ end_date }}">
    </div>
    <div class="col-md-3 d-flex gap-2">
      <button type="submit" class="btn btn-primary w-100">Filter</button>
      <a href="?{% if gender_filter %}gender={{ gender_filter }}&{% endif %}{% if start_date %}start_date={{ start_date }}&{% endif %}{% if end_date %}end_date={{ end_date }}&{% endif %}download=csv" class="btn btn-success w-100">
        <i class="bi bi-download"></i> Download CSV
      </a>
    </div>
  </form>

  <div class="row g-4">
    {% for chart in chart_list %}
      <div class="col-md-{{ chart.width|default:6 }}">
        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="card-title">{{ chart.title }}</h5>
            <canvas id="{{ chart.id }}" height="200"></canvas>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

<!-- Chart.js -->
<script src="{% static 'js/chart.umd.min.js' %}"></script>
<script>
  const chartConfigs = {
    {% for chart in chart_list %}
    "{{ chart.id }}": {
      type: "{{ chart.type }}",
      data: {{ chart.data|safe }},
      options: {
        responsive: true,
        plugins: {
          legend: { position: "{{ chart.legend_position|default:'top' }}" },
          title: { display: true, text: "{{ chart.title }}" }
        },
        {% if chart.index_axis %}indexAxis: "{{ chart.index_axis }}",{% endif %}
      }
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
  };

  for (const [id, config] of Object.entries(chartConfigs)) {
    const ctx = document.getElementById(id);
    if (ctx) {
      new Chart(ctx, config);
    }
  }
</script>
{% endblock %}