{% extends 'home/tes.html' %}
{% block content %}
    <div class="container mt-4">
        <h1>{{ microcredential.title }}</h1>

        <!-- Gambar MicroCredential -->
        {% if microcredential.image %}
            <img src="{{ microcredential.image.url }}" alt="{{ microcredential.title }}" class="img-fluid mb-3" style="max-width: 300px;">
        {% endif %}

        <!-- Deskripsi -->
        <p>{{ microcredential.description|safe }}</p>

        <!-- Informasi Tambahan -->
        <div class="mb-3">
            <p><strong>Category:</strong> {% if microcredential.category %}{{ microcredential.category }}{% else %}N/A{% endif %}</p>
            <p><strong>Status:</strong> {{ microcredential.status|title }}</p>
            <p><strong>Start Date:</strong> {% if microcredential.start_date %}{{ microcredential.start_date|date:"M d, Y" }}{% else %}N/A{% endif %}</p>
            <p><strong>End Date:</strong> {% if microcredential.end_date %}{{ microcredential.end_date|date:"M d, Y" }}{% else %}N/A{% endif %}</p>
            <p><strong>Created:</strong> {{ microcredential.created_at|date:"M d, Y" }}</p>
            <p><strong>Last Edited:</strong> {{ microcredential.edited_on|date:"M d, Y" }}</p>
            <p><strong>Author:</strong> {{ microcredential.author.username }}</p>
        </div>

        <!-- Tombol Enrollment -->
        {% if not is_enrolled %}
            {% if microcredential.status == 'active' and current_date >= microcredential.start_date|default:current_date and current_date <= microcredential.end_date|default:current_date %}
                <a href="{% url 'courses:enroll_microcredential' slug=microcredential.slug %}" class="btn btn-primary mb-3">Enroll Now</a>
            {% else %}
                <p class="text-muted">Enrollment is not currently available.</p>
            {% endif %}
        {% else %}
            <p class="text-success">You are already enrolled in this MicroCredential.</p>
        {% endif %}

        <!-- Status Kelulusan -->
        <div class="alert {% if microcredential_passed %}alert-success{% else %}alert-warning{% endif %}" role="alert">
            {% if microcredential_passed %}
                <h4 class="alert-heading">Congratulations, {{ request.user.username }}!</h4>
                <p>You have successfully completed this MicroCredential!</p>
            {% else %}
                <h4 class="alert-heading">Not Yet Complete</h4>
                <p>You need to complete all required courses and achieve a total score of at least {{ min_total_score }} to earn this MicroCredential.</p>
            {% endif %}
            <hr>
            <p class="mb-0"><strong>Your Total Score:</strong> {{ total_user_score|floatformat:2 }} / {{ total_max_score|floatformat:2 }}</p>
            <p><strong>Minimum Total Score Required:</strong> {{ min_total_score|floatformat:2 }}</p>
        </div>

        <!-- Daftar Kursus yang Diperlukan -->
        <h2>Required Courses</h2>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Course Name</th>
                    <th>Your Score</th>
                    <th>Max Score</th>
                    <th>Min Score</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for progress in course_progress %}
                    <tr>
                        <td>
                            <a href="{% url 'courses:course_learn' username=request.user.username slug=progress.course.slug %}">
                                {{ progress.course.course_name }}
                            </a>
                        </td>
                        <td>{{ progress.user_score|floatformat:2 }}</td>
                        <td>{{ progress.max_score|floatformat:2 }}</td>
                        <td>{{ progress.min_score|floatformat:2 }}</td>
                        <td>
                            {% if progress.passed %}
                                <span class="badge bg-success">Passed</span>
                            {% elif progress.completed %}
                                <span class="badge bg-warning">Completed (Below Minimum)</span>
                            {% else %}
                                <span class="badge bg-danger">Not Completed</span>
                            {% endif %}
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="5">No required courses found.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Tombol Download Sertifikat -->
        {% if microcredential_passed %}
            <a href="{% url 'courses:generate_microcredential_certificate' microcredential.id %}" class="btn btn-success">Download Certificate</a>
        {% endif %}
    </div>
{% endblock %}