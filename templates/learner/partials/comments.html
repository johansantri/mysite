{% load learner_tags %}
<div class="comments mt-4" id="comments-section">
    <h5 class="fw-semibold text-dark">Comments</h5>
    <p class="text-muted small mb-3">Please keep comments relevant to the discussion topic and avoid content containing hate speech, pornography, or spam.</p>


    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}

    {% if user.is_authenticated %}
        <form hx-post="{% url 'learner:add_comment' %}"
              hx-target="#comments-section"
              hx-swap="innerHTML"
              hx-on::after-request="document.body.dispatchEvent(new Event('contentLoaded')); this.reset()"
              class="mb-4 card card-body shadow-sm border-0 bg-light">
            <input type="hidden" name="material_id" value="{{ material.id|default:'' }}">
            <input type="hidden" name="parent_id" value="">

            <div class="mb-3">
                <label for="comment_text" class="form-label">Write your feedback</label>
                <textarea name="comment_text" class="form-control" rows="4" placeholder="Leave your comment..." required></textarea>
            </div>

            <button type="submit" class="btn btn-primary">
                <i class="bi bi-send me-1"></i> Post Comment
            </button>
        </form>
    {% else %}
        <div class="alert alert-secondary small" role="alert">
            Please <a href="{% url 'login' %}" class="alert-link">log in</a> to add a comment.

        </div>
    {% endif %}

    <div class="mt-4">
        {% for comment in comments %}
            {% include 'learner/partials/comment.html' with comment=comment user_reactions=user_reactions level=0 %}
        {% empty %}
            <p class="text-muted fst-italic">No comments available.</p>
        {% endfor %}
    </div>
</div>

<!-- Optional Custom CSS (masukkan ke file CSS eksternal) -->
<style>
    .border-left-reply {
        border-left: 4px solid var(--bs-primary);
    }

    .reply-form {
        background-color: var(--bs-light);
        border-radius: 0.25rem;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        document.body.addEventListener('htmx:afterSwap', function (event) {
            if (event.detail.target.id === 'comments-section') {
                document.querySelectorAll('.reply-form.show').forEach(form => {
                    form.classList.remove('show');
                });
            }
        });
    });
</script>
