{% load learner_tags %}
<!-- Completion Card atau Warning -->
{% get_course_completion_status as completion_status %}
{% with is_completed=completion_status.is_completed certificate_url=completion_status.certificate_url assessments_completed_percentage=completion_status.assessments_completed_percentage course_progress=completion_status.course_progress overall_percentage=completion_status.overall_percentage passing_threshold=completion_status.passing_threshold %}
    {% if not next_url %}
        {% if is_completed %}
            <div class="completion-overlay" id="completion-overlay">
                <div class="card shadow-lg border-0 text-center p-5 completed-card mx-auto" style="max-width: 900px; width: 90%;" role="alert" aria-label="Selamat, Anda telah lulus kursus {{ course_name }}">
                    <div class="mb-4">
                        <i class="bi bi-trophy display-2 text-success"></i>
                    </div>
                    <h1 class="fw-bold text-success mb-3">Congratulations, You Passed!</h1>
                    <p class="text-muted mb-4 fs-4">
                       <span class="text-success"> {{ request.user.get_full_name|default:request.user.username }}</span>, you have successfully completed the course <strong>{{ course_name }}</strong>!<br>
                        Final score: <strong>{{ overall_percentage }}%</strong> (Passing threshold: {{ passing_threshold }}%).
                    </p>


                    <div class="d-flex justify-content-center gap-3 flex-wrap">
                        <a href="{% url 'authentication:dashbord' %}"
                           class="btn btn-primary btn-lg">
                            <i class="bi bi-house-door me-2"></i>KGo Back to Dashboard
                        </a>
                        {% if certificate_url %}
                            <a href="{{ certificate_url }}"
                               class="btn btn-outline-success btn-lg"
                               target="_blank">
                                <i class="bi bi-award me-2"></i>Get Certificate
                            </a>
                        {% endif %}
                        <button class="btn btn-secondary btn-lg"
                                onclick="document.getElementById('completion-overlay').style.display='none';"
                                aria-label="Tutup kartu kelulusan">
                            <i class="bi bi-x-circle me-2"></i>Close
                        </button>
                    </div>
                </div>
            </div>
        {% elif course_progress >= 100 and not is_completed %}
            <div class="mt-4">
                <div class="alert alert-warning text-center p-4 mx-auto" style="max-width: 800px;" role="alert" aria-label="Peringatan: Persyaratan kelulusan belum terpenuhi">
                    <i class="bi bi-exclamation-triangle me-2 fs-4"></i>
                    {% if overall_percentage < passing_threshold %}
                        Hello <span class="text-danger">  {{ request.user.get_full_name|default:request.user.username }} </span>, your score (<strong>{{ overall_percentage }}%</strong>) has not reached the passing threshold (<strong>{{ passing_threshold }}%</strong>). Please try to improve your score.
                    {% else %}
                        Hello <span class="text-danger"> {{ request.user.get_full_name|default:request.user.username }}</span>, you have not completed all assessments. Please complete them to pass this course.
                    {% endif %}

                </div>
            </div>
        {% endif %}
    {% endif %}

    <!-- Tombol Navigasi -->
    <div class="d-flex justify-content-between mt-4 mb-4">
        <!-- Tombol Sebelumnya -->
        {% if previous_url %}
            <a href="{{ previous_url }}"
               hx-get="{{ previous_url }}"
               hx-target="#content-area"
               hx-swap="innerHTML"
               hx-push-url="true"
               class="btn btn-primary"
               hx-on::after-request="document.body.dispatchEvent(new Event('contentLoaded'))">
                <i class="bi bi-chevron-left me-2"></i>Previous
            </a>
        {% else %}
            <button class="btn btn-primary" disabled><i class="bi bi-chevron-left me-2"></i>Previous</button>
        {% endif %}

        <!-- Tombol Selanjutnya -->
        {% if next_url %}
            <a href="{{ next_url }}"
            hx-get="{{ next_url }}"
            hx-target="#content-area"
            hx-swap="innerHTML"
            hx-push-url="true"
            class="btn btn-primary"
            hx-on::after-request="htmx.trigger('#progress-bar', 'load')">
                Next<i class="bi bi-chevron-right ms-2"></i>
            </a>
        {% else %}
            <button class="btn btn-primary" disabled>Next<i class="bi bi-chevron-right ms-2"></i></button>
        {% endif %}
    </div>
{% endwith %}

<!-- Animasi CSS -->
<style>
@keyframes fadeIn {
    0% { opacity: 0; transform: translateY(20px); }
    100% { opacity: 1; transform: translateY(0); }
}
.completion-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    overflow-y: auto;
}
.completed-card {
    animation: fadeIn 0.8s ease-out;
    background: linear-gradient(135deg, #ffffff, #f1f3f5);
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    padding: 2rem;
}
@media (max-width: 576px) {
    .completed-card {
        width: 95%;
        padding: 1.5rem;
    }
    .completed-card h1 {
        font-size: 1.75rem;
    }
    .completed-card p {
        font-size: 1rem;
    }
}
</style>

<!-- Efek Confetti -->
<script src="https://cdn.jsdelivr.net/npm/js-confetti@0.11.0/dist/js-confetti.browser.js"></script>
<script>
    {% if completion_status.is_completed and not next_url %}
        const jsConfetti = new JSConfetti();
        jsConfetti.addConfetti({
            confettiNumber: 300,
            confettiRadius: 8,
            confettiSpeed: 30,
            confettiColors: ['#ff0a54', '#ff477e', '#ff7096', '#ff85a1', '#00d4ff', '#00b7eb', '#ffd700'],
            spread: 360
        }).then(() => {
            setTimeout(() => {
                jsConfetti.addConfetti({
                    confettiNumber: 200,
                    confettiRadius: 6,
                    confettiSpeed: 25,
                    confettiColors: ['#ff0a54', '#ff477e', '#00d4ff', '#ffd700']
                });
            }, 1000);
        });
    {% endif %}
</script>


<script>
    document.body.addEventListener('contentLoaded', () => {
        console.log('Peristiwa contentLoaded dipicu dari tombol Next');
    });
</script>