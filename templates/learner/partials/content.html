{% load learner_tags %}

<div class="container-fluid py-4">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 sidebar p-3 rounded">
            <h4 class="mb-3">{{ course_name|default:"Kursus Tidak Ditemukan" }}</h4>
            <div class="progress mb-3" id="progress-bar"
                 hx-get="{% url 'learner:get_progress' username=username slug=slug %}"
                 hx-trigger="load, contentLoaded from:body"
                 hx-swap="innerHTML">
                <div class="progress-bar bg-success" role="progressbar" style="width: {{ course_progress|default:0 }}%;" 
                     aria-valuenow="{{ course_progress|default:0 }}" aria-valuemin="0" aria-valuemax="100">
                    {{ course_progress|default:0|floatformat:0 }}%
                </div>
            </div>
            <ul class="list-group">
                {% for section in sections %}
                    <li class="list-group-item border-0">
                        <strong>{{ section.title }}</strong>
                        <ul class="list-group list-group-flush">
                            {% for material in section.materials.all %}
                                <li class="list-group-item border-0">
                                    <a href="{% url 'learner:load_content' username=username slug=slug content_type='material' content_id=material.id %}"
                                       hx-get="{% url 'learner:load_content' username=username slug=slug content_type='material' content_id=material.id %}"
                                       hx-target="#content-area"
                                       hx-swap="innerHTML"
                                       hx-push-url="true"
                                       class="text-decoration-none text-dark"
                                       hx-on::after-request="document.body.dispatchEvent(new Event('contentLoaded'))">
                                        <i class="bi bi-file-text me-2"></i>{{ material.title }}
                                    </a>
                                </li>
                            {% endfor %}
                            {% for assessment in section.assessments.all %}
                                <li class="list-group-item border-0">
                                    <a href="{% url 'learner:load_content' username=username slug=slug content_type='assessment' content_id=assessment.id %}"
                                       hx-get="{% url 'learner:load_content' username=username slug=slug content_type='assessment' content_id=assessment.id %}"
                                       hx-target="#content-area"
                                       hx-swap="innerHTML"
                                       hx-push-url="true"
                                       class="text-decoration-none text-dark"
                                       hx-on::after-request="document.body.dispatchEvent(new Event('contentLoaded'))">
                                        <i class="bi bi-question-circle me-2"></i>{{ assessment.name }}
                                        {% if assessment_locked and assessment.id == current_content.1.id %}
                                            <span class="badge bg-warning ms-2">Terkunci</span>
                                        {% endif %}
                                    </a>
                                </li>
                            {% endfor %}
                        </ul>
                    </li>
                {% empty %}
                    <li class="list-group-item border-0">
                        <p class="text-muted">Tidak ada section tersedia.</p>
                    </li>
                {% endfor %}
            </ul>
        </div>
        <!-- Konten Utama -->
        <div class="col-md-9 content-column" id="content-area">
            {% if current_content %}
                {% if current_content.0 == 'material' %}
                    <h3 class="mb-4">{{ material.title }}</h3>
                    <div class="content-body">{{ material.description|safe }}</div>
                    <div id="comments-section" class="mt-5">
                        {% include 'learner/partials/comments.html' %}
                    </div>

                {% elif current_content.0 == 'assessment' %}
                    {% if assessment_locked %}
                        <div class="alert alert-warning">
                            Ujian ini memerlukan pembayaran.
                            <a href="{{ payment_required_url }}" class="btn btn-warning btn-sm ms-2">Lanjutkan ke Pembayaran</a>
                        </div>
                    {% else %}
                        <h3 class="mb-4">{{ assessment.name }}</h3>

                        {% if ask_oras %}
                            <h4>Pertanyaan AskOra</h4>
                            {% for ask_ora in ask_oras %}
                                <div class="card mb-4">
                                    <div class="card-body">
                                        <h5>{{ ask_ora.title }}</h5>
                                        <div class="mb-3">
                                            {{ ask_ora.question_text|safe }}
                                        </div>
                                        <p class="text-muted">
                                            <i class="bi bi-clock"></i> 
                                            Batas waktu: {{ ask_ora.response_deadline|date:"d M Y H:i" }}
                                        </p>
                                        
                                        {% if askora_can_submit|dict_get:ask_ora.id %}
                                            <form method="POST"
                                                hx-post="{% url 'learner:submit_answer_askora_new' ask_ora.id %}"
                                                hx-target="#content-area"
                                                hx-swap="innerHTML"
                                                enctype="multipart/form-data"
                                                class="mt-4">
                                                {% csrf_token %}
                                                
                                                <div class="mb-3">
                                                    <label for="answer_text" class="form-label">
                                                        <i class="bi bi-pencil-square"></i> Jawaban Anda
                                                    </label>
                                                    <textarea name="answer_text" id="answer_text" 
                                                        class="form-control" rows="6" required
                                                        placeholder="Tulis jawaban Anda disini..."></textarea>
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <label for="answer_file" class="form-label">
                                                        <i class="bi bi-paperclip"></i> Lampirkan File (Opsional)
                                                    </label>
                                                    <input type="file" class="form-control" 
                                                        name="answer_file" id="answer_file">
                                                </div>
                                                
                                                <button type="submit" class="btn btn-primary">
                                                    <span class="htmx-indicator">
                                                        <span class="spinner-border spinner-border-sm" role="status"></span>
                                                        Mengirim...
                                                    </span>
                                                    <span class="non-htmx-indicator">
                                                        <i class="bi bi-send"></i> Kirim Jawaban
                                                    </span>
                                                </button>
                                            </form>
                                        {% else %}
                                            <div class="alert alert-secondary">
                                                {% if not ask_ora.is_responsive %}
                                                    <i class="bi bi-exclamation-circle"></i> Batas waktu pengiriman telah berakhir.
                                                {% else %}
                                                    <i class="bi bi-check-circle"></i> Anda sudah mengirimkan jawaban.
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        {% endif %}

                        <!-- Bagian Jawaban User -->
                        {% if user_submissions %}
                            <div class="mt-5">
                                <h4><i class="bi bi-journal-text"></i> Jawaban Saya</h4>
                                
                                {% for submission in user_submissions %}
                                    <div class="card mb-4 {% if submission.score %}border-primary{% endif %}">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start mb-3">
                                                <h5>{{ submission.askora.title }}</h5>
                                                {% if submission.score %}
                                                    <span class="badge bg-primary fs-6">
                                                        Nilai: {{ submission.score }}
                                                    </span>
                                                {% endif %}
                                            </div>
                                            
                                            <div class="mb-3">
                                                <p class="text-muted">
                                                    <i class="bi bi-clock"></i> 
                                                    Dikirim pada: {{ submission.submitted_at|date:"d M Y H:i" }}
                                                </p>
                                                <div class="bg-light p-3 rounded">
                                                    {{ submission.answer_text|linebreaks }}
                                                </div>
                                            </div>
                                            
                                            {% if submission.answer_file %}
                                                <a href="{{ submission.answer_file.url }}" class="btn btn-sm btn-outline-primary">
                                                    <i class="bi bi-download"></i> Unduh File Lampiran
                                                </a>
                                            {% endif %}
                                            
                                            

                                            <!-- Bagian Status Penilaian -->
                                                <div class="mt-4 p-3 bg-light rounded">
                                                    <h6><i class="bi bi-info-circle"></i> Status Penilaian:</h6>
                                                    <ul class="mb-0">
                                                        <li>
                                                            <i class="bi bi-people-fill"></i> Telah direview oleh 
                                                            {{ peer_review_stats.distinct_reviewers }} dari 
                                                            {{ peer_review_stats.total_participants }} teman
                                                            {% if peer_review_stats.completed %}
                                                                <span class="badge bg-success ms-2">Selesai</span>
                                                            {% else %}
                                                                <span class="badge bg-warning ms-2">Proses</span>
                                                            {% endif %}
                                                        </li>
                                                        <li>
                                                            <i class="bi bi-star-fill"></i> Rata-rata nilai: 
                                                            {% if peer_review_stats.avg_score %}
                                                                <strong>{{ peer_review_stats.avg_score }}</strong>/5.00
                                                            {% else %}
                                                                <span class="text-muted">Belum ada nilai</span>
                                                            {% endif %}
                                                        </li>
                                                        <li>
                                                            <i class="bi bi-clock"></i> Estimasi selesai: 
                                                            {% if peer_review_stats.completed %}
                                                                <span class="text-success">Penilaian telah selesai</span>
                                                            {% else %}
                                                                {% with remaining=peer_review_stats.total_participants|subtract:peer_review_stats.distinct_reviewers %}
                                                                    {% if remaining == 1 %}
                                                                        Menunggu 1 review terakhir
                                                                    {% else %}
                                                                        Menunggu {{ remaining }} review lagi
                                                                    {% endif %}
                                                                {% endwith %}
                                                            {% endif %}
                                                        </li>
                                                    </ul>
                                                    
                                                   
                                                </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}

                        <!-- Bagian Peer Review -->
                        {% if can_review and submissions %}
                            <div id="peer-review-section" class="mt-5 border-top pt-4">
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <h4><i class="bi bi-people-fill"></i> Tinjau Jawaban Teman</h4>
                                    <span class="badge bg-info">
                                        {{ submissions|length }} jawaban perlu direview
                                    </span>
                                </div>
                                
                                <div class="alert alert-info">
                                    <h5><i class="bi bi-lightbulb"></i> Panduan Review:</h5>
                                    <ol class="mb-0">
                                        <li>Baca jawaban dengan seksama</li>
                                        <li>Berikan skor 1-5 (1 = sangat buruk, 5 = sangat baik)</li>
                                        <li>Beri komentar yang membangun (opsional)</li>
                                        <li>Review Anda akan mempengaruhi nilai teman</li>
                                    </ol>
                                </div>

                                {% for submission in submissions %}
                                    <div class="card mb-4">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start mb-3">
                                                <h5>{{ submission.askora.title }}</h5>
                                                <small class="text-muted">
                                                    Oleh: {{ submission.user.get_full_name|default:submission.user.username }}
                                                </small>
                                            </div>
                                            
                                            <div class="mb-4 p-3 bg-light rounded">
                                                <p class="fw-bold mb-2">Jawaban:</p>
                                                {{ submission.answer_text|linebreaks }}
                                                
                                                {% if submission.answer_file %}
                                                <div class="mt-2">
                                                    <a href="{{ submission.answer_file.url }}" class="btn btn-sm btn-outline-secondary">
                                                        <i class="bi bi-download"></i> Unduh File
                                                    </a>
                                                </div>
                                                {% endif %}
                                            </div>
                                            
                                            <form method="post" 
                                                hx-post="{% url 'learner:submit_peer_review_new' submission.id %}"
                                                hx-target="#content-area"
                                                hx-swap="innerHTML">
                                                {% csrf_token %}
                                                
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-star-fill"></i> Berikan Nilai
                                                    </label>
                                                    <select name="score" class="form-select" required>
                                                        <option value="">Pilih skor 1-5</option>
                                                        <option value="1">1 - Sangat Buruk</option>
                                                        <option value="2">2 - Buruk</option>
                                                        <option value="3">3 - Cukup</option>
                                                        <option value="4">4 - Baik</option>
                                                        <option value="5">5 - Sangat Baik</option>
                                                    </select>
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <i class="bi bi-chat-left-text"></i> Komentar (opsional)
                                                    </label>
                                                    <textarea name="comment" class="form-control" rows="3" 
                                                        placeholder="Berikan masukan yang membangun..."></textarea>
                                                </div>
                                                
                                                <button type="submit" class="btn btn-primary">
                                                    <i class="bi bi-send"></i> Kirim Review
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}

                        <!-- Bagian untuk Skor Kuis -->
                        {% if course_scores %}
                            <h4>Hasil Kuis</h4>
                            {% for score in course_scores %}
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <p><strong>Skor:</strong> {{ score.score }}/{{ score.total_questions }} ({{ score.grade }})</p>
                                        <p><strong>Waktu:</strong> {{ score.date }}</p>
                                    </div>
                                </div>
                            {% endfor %}
                        {% endif %}

                        <!-- Bagian untuk soal pilihan ganda (quiz) dengan timer -->
                        {% if is_quiz %}
                            {% if is_started %}
                                {% if is_expired %}
                                    <div class="alert alert-danger">Penilaian ini telah kedaluwarsa.</div>
                                    {% for question in assessment.questions.all %}
                                        <div class="card mb-3 border 
                                            {% with answer=answered_questions|get_question_answer:question.id %}
                                                {% if answer and answer.choice.is_correct %}
                                                    border-success
                                                {% else %}
                                                    border-danger
                                                {% endif %}
                                            {% endwith %}">
                                            <div class="card-body">
                                                <h5>{{ question.text }}</h5>
                                                <ul class="list-group">
                                                    {% for choice in question.choices.all %}
                                                        {% with answer=answered_questions|get_question_answer:question.id %}
                                                            <li class="list-group-item
                                                                {% if choice.is_correct %}
                                                                    list-group-item-success
                                                                {% elif answer and answer.choice.id == choice.id %}
                                                                    list-group-item-danger
                                                                {% endif %}">
                                                                {{ choice.text }}
                                                                {% if choice.is_correct %}
                                                                    <span class="badge bg-success">Benar</span>
                                                                {% endif %}
                                                                {% if answer and answer.choice.id == choice.id %}
                                                                    <span class="badge bg-primary">Jawaban Anda</span>
                                                                {% endif %}
                                                            </li>
                                                        {% endwith %}
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="alert alert-info mb-4">
                                        Waktu tersisa: <span id="timer">{{ remaining_time }}</span> detik
                                    </div>
                                    {% for question in assessment.questions.all %}
                                        <div class="card mb-3">
                                            <div class="card-body">
                                                <h5>{{ question.text }}</h5>
                                                <form 
                                                    hx-post="{% url 'learner:submit_answer' %}"
                                                    hx-target="#content-area"
                                                    hx-swap="innerHTML"
                                                    hx-on::after-request="document.body.dispatchEvent(new Event('contentLoaded'))"
                                                    method="POST">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="question_id" value="{{ question.id }}">
                                                    {% for choice in question.choices.all %}
                                                        <div class="form-check mb-2">
                                                            {% with answer=answered_questions|get_question_answer:question.id %}
                                                                <input type="radio"
                                                                       name="choice_id"
                                                                       value="{{ choice.id }}"
                                                                       class="form-check-input"
                                                                       {% if answer and answer.choice.id == choice.id %}checked{% endif %}>
                                                                <label class="form-check-label">{{ choice.text }}</label>
                                                            {% endwith %}
                                                        </div>
                                                    {% endfor %}
                                                    <button type="submit" class="btn btn-primary mt-2">Kirim Jawaban</button>
                                                </form>
                                            </div>
                                        </div>
                                    {% endfor %}
                                    <!-- Timer Script -->
                                    <script>
                                        (function() {
                                            const timerElement = document.getElementById('timer');
                                            if (timerElement && !timerElement.dataset.timerInitialized) {
                                                let timeLeft = parseInt(timerElement.textContent);
                                                timerElement.dataset.timerInitialized = 'true';
                                                const interval = setInterval(() => {
                                                    timeLeft--;
                                                    timerElement.textContent = timeLeft;
                                                    if (timeLeft <= 0) {
                                                        clearInterval(interval);
                                                        htmx.ajax('POST', '{% url "learner:submit_assessment" assessment.id %}', {
                                                            target: '#content-area',
                                                            swap: 'innerHTML'
                                                        });
                                                    }
                                                }, 1000);
                                            }
                                        })();
                                    </script>
                                {% endif %}
                            {% else %}
                                <!-- Hanya untuk quiz, tampilkan tombol mulai penilaian -->
                                <button type="button" class="btn btn-success" onclick="document.getElementById('manual-confirmation').style.display = 'block'">
                                    Mulai Penilaian
                                </button>
                                <div id="manual-confirmation" class="mt-4 p-3 border rounded bg-light" style="display: none;">
                                    <p class="mb-3">
                                        Sebelum memulai ujian, Anda memiliki <strong>{{ assessment.duration_in_minutes }} menit</strong> untuk menyelesaikannya. Apakah Anda setuju untuk melanjutkan?
                                    </p>
                                    <div class="d-flex gap-2">
                                        <form 
                                            hx-post="{% url 'learner:start_assessment' assessment.id %}"
                                            hx-target="#content-area"
                                            hx-swap="innerHTML"
                                            hx-push-url="{% url 'learner:load_content' username=username slug=slug content_type='assessment' content_id=assessment.id %}">
                                            <button type="submit" class="btn btn-primary">Setuju</button>
                                        </form>
                                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('manual-confirmation').style.display = 'none'">
                                            Batal
                                        </button>
                                    </div>
                                </div>
                            {% endif %}
                        {% endif %}

                    {% endif %}
                {% endif %}

                <!-- Tombol Navigasi -->
                <div class="d-flex justify-content-between mt-4">
                    {% if previous_url %}
                        <a href="{{ previous_url }}"
                           hx-get="{{ previous_url }}"
                           hx-target="#content-area"
                           hx-swap="innerHTML"
                           hx-push-url="true"
                           class="btn btn-primary"
                           hx-on::after-request="document.body.dispatchEvent(new Event('contentLoaded'))">
                            <i class="bi bi-chevron-left me-2"></i>Sebelumnya
                        </a>
                    {% else %}
                        <button class="btn btn-primary" disabled><i class="bi bi-chevron-left me-2"></i>Sebelumnya</button>
                    {% endif %}
                    {% if next_url %}
                        <a href="{{ next_url }}"
                           hx-get="{{ next_url }}"
                           hx-target="#content-area"
                           hx-swap="innerHTML"
                           hx-push-url="true"
                           class="btn btn-primary"
                           hx-on::after-request="document.body.dispatchEvent(new Event('contentLoaded'))">
                            Selanjutnya<i class="bi bi-chevron-right ms-2"></i>
                        </a>
                    {% else %}
                        <button class="btn btn-primary" disabled>Selanjutnya<i class="bi bi-chevron-right ms-2"></i></button>
                    {% endif %}
                </div>

            {% else %}
                <p>Pilih materi atau penilaian dari sidebar.</p>
            {% endif %}
        </div>
    </div>
</div>
