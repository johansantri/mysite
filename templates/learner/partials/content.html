{% load learner_tags %}

<div class="container-fluid py-4">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 sidebar p-3 rounded">
            <h4 class="mb-3">{{ course_name|default:"Kursus Tidak Ditemukan" }}</h4>
            <div class="progress mb-3" id="progress-bar"
                 hx-get="{% url 'learner:get_progress' username=username slug=slug %}"
                 hx-trigger="load, contentLoaded from:body"
                 hx-swap="innerHTML">
                <div class="progress-bar bg-success" role="progressbar" style="width: {{ course_progress|default:0 }}%;" 
                     aria-valuenow="{{ course_progress|default:0 }}" aria-valuemin="0" aria-valuemax="100">
                    {{ course_progress|default:0|floatformat:0 }}%
                </div>
            </div>
            <ul class="list-group">
                {% for section in sections %}
                    <li class="list-group-item border-0">
                        <strong>{{ section.title }}</strong>
                        <ul class="list-group list-group-flush">
                            {% for material in section.materials.all %}
                                <li class="list-group-item border-0">
                                    <a href="{% url 'learner:load_content' username=username slug=slug content_type='material' content_id=material.id %}"
                                       hx-get="{% url 'learner:load_content' username=username slug=slug content_type='material' content_id=material.id %}"
                                       hx-target="#content-area"
                                       hx-swap="innerHTML"
                                       hx-push-url="true"
                                       class="text-decoration-none text-dark"
                                       hx-on::after-request="document.body.dispatchEvent(new Event('contentLoaded'))">
                                        <i class="bi bi-file-text me-2"></i>{{ material.title }}
                                    </a>
                                </li>
                            {% endfor %}
                            {% for assessment in section.assessments.all %}
                                <li class="list-group-item border-0">
                                    <a href="{% url 'learner:load_content' username=username slug=slug content_type='assessment' content_id=assessment.id %}"
                                       hx-get="{% url 'learner:load_content' username=username slug=slug content_type='assessment' content_id=assessment.id %}"
                                       hx-target="#content-area"
                                       hx-swap="innerHTML"
                                       hx-push-url="true"
                                       class="text-decoration-none text-dark"
                                       hx-on::after-request="document.body.dispatchEvent(new Event('contentLoaded'))">
                                        <i class="bi bi-question-circle me-2"></i>{{ assessment.name }}
                                        {% if assessment_locked and assessment.id == current_content.1.id %}
                                            <span class="badge bg-warning ms-2">Terkunci</span>
                                        {% endif %}
                                    </a>
                                </li>
                            {% endfor %}
                        </ul>
                    </li>
                {% empty %}
                    <li class="list-group-item border-0">
                        <p class="text-muted">Tidak ada section tersedia.</p>
                    </li>
                {% endfor %}
            </ul>
        </div>
        <!-- Konten Utama -->
        <div class="col-md-9 content-column" id="content-area">
            {% if current_content %}
                {% if current_content.0 == 'material' %}
                    <h3 class="mb-4">{{ material.title }}</h3>
                    <div class="content-body">{{ material.description|safe }}</div>
                {% elif current_content.0 == 'assessment' %}
                    {% if assessment_locked %}
                        <div class="alert alert-warning">
                            Ujian ini memerlukan pembayaran.
                            <a href="{{ payment_required_url }}" class="btn btn-warning btn-sm ms-2">Lanjutkan ke Pembayaran</a>
                        </div>
                    {% else %}
                        <h3 class="mb-4">{{ assessment.name }}</h3>
                        {% if is_started %}
                            {% if is_expired %}
                                <div class="alert alert-danger">Penilaian ini telah kedaluwarsa.</div>
                                     {% for question in assessment.questions.all %}
                                            <div class="card mb-3 border {% with answer=answered_questions|get_question_answer:question.id %}{% if answer and answer.choice.is_correct %}border-success{% else %}border-danger{% endif %}{% endwith %}">
                                                <div class="card-body">
                                                    <h5>{{ question.text }}</h5>
                                                    <ul class="list-group">
                                                        {% for choice in question.choices.all %}
                                                            {% with answer=answered_questions|get_question_answer:question.id %}
                                                                <li class="list-group-item
                                                                    {% if choice.is_correct %}
                                                                        list-group-item-success
                                                                    {% elif answer and answer.choice.id == choice.id %}
                                                                        list-group-item-danger
                                                                    {% endif %}">
                                                                    {{ choice.text }}
                                                                    {% if choice.is_correct %}
                                                                        <span class="badge bg-success">Benar</span>
                                                                    {% endif %}
                                                                    {% if answer and answer.choice.id == choice.id %}
                                                                        <span class="badge bg-primary">Jawaban Anda</span>
                                                                    {% endif %}
                                                                </li>
                                                            {% endwith %}
                                                        {% endfor %}
                                                    </ul>
                                                </div>
                                            </div>
                                        {% endfor %}

                            {% else %}
                                <div class="alert alert-info mb-4">
                                    Waktu tersisa: <span id="timer">{{ remaining_time }}</span> detik
                                </div>
                                {% for question in assessment.questions.all %}
                                    <div class="card mb-3">
                                        <div class="card-body">
                                            <h5>{{ question.text }}</h5>
                                            <form 
                                                    hx-post="{% url 'learner:submit_answer' %}"
                                                    hx-target="#content-area"
                                                    hx-swap="innerHTML"
                                                    hx-on::after-request="document.body.dispatchEvent(new Event('contentLoaded'))"
                                                    method="POST"
                                                >
                                                    {% csrf_token %}
                                                    <input type="hidden" name="question_id" value="{{ question.id }}">

                                                    {% for choice in question.choices.all %}
                                                        <div class="form-check mb-2">
                                                            {% with answer=answered_questions|get_question_answer:question.id %}
                                                                <input type="radio"
                                                                    name="choice_id"
                                                                    value="{{ choice.id }}"
                                                                    class="form-check-input"
                                                                    {% if answer and answer.choice.id == choice.id %}checked{% endif %}>
                                                                <label class="form-check-label">{{ choice.text }}</label>
                                                            {% endwith %}
                                                        </div>
                                                    {% endfor %}

                                                    <button type="submit" class="btn btn-primary mt-2">Kirim Jawaban</button>
                                                </form>

                                        </div>
                                    </div>
                                {% endfor %}
                                <!-- Timer Script -->
                                <script>
                                    (function() {
                                        const timerElement = document.getElementById('timer');
                                        if (timerElement && !timerElement.dataset.timerInitialized) {
                                            let timeLeft = parseInt(timerElement.textContent);
                                            timerElement.dataset.timerInitialized = 'true';
                                            const interval = setInterval(() => {
                                                timeLeft--;
                                                timerElement.textContent = timeLeft;
                                                if (timeLeft <= 0) {
                                                    clearInterval(interval);
                                                    htmx.ajax('POST', '{% url "learner:submit_assessment" assessment.id %}', {
                                                        target: '#content-area',
                                                        swap: 'innerHTML'
                                                    });
                                                }
                                            }, 1000);
                                        }
                                    })();
                                </script>
                            {% endif %}
                        {% else %}
                            <!-- Tombol untuk membuka konfirmasi -->
                                <button type="button" class="btn btn-success" onclick="document.getElementById('manual-confirmation').style.display = 'block'">
                                    Mulai Penilaian
                                </button>

                                <!-- Konfirmasi manual -->
                                <div id="manual-confirmation" class="mt-4 p-3 border rounded bg-light" style="display: none;">
                                    <p class="mb-3">
                                        Sebelum memulai ujian, Anda memiliki <strong>{{ assessment.duration_in_minutes }} menit</strong> untuk menyelesaikannya. Apakah Anda setuju untuk melanjutkan?
                                    </p>
                                    <div class="d-flex gap-2">
                                        <form 
                                            hx-post="{% url 'learner:start_assessment' assessment.id %}"
                                            hx-target="#content-area"
                                            hx-swap="innerHTML"
                                            hx-push-url="{% url 'learner:load_content' username=username slug=slug content_type='assessment' content_id=assessment.id %}">
                                            <button type="submit" class="btn btn-primary">Setuju</button>
                                        </form>
                                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('manual-confirmation').style.display = 'none'">
                                            Batal
                                        </button>
                                    </div>
                                </div>

                        {% endif %}
                    {% endif %}
                {% endif %}
                <div id="comments-section" class="mt-5">
                    {% include 'learner/partials/comments.html' %}
                </div>
                <!-- Tombol Navigasi -->
                <div class="d-flex justify-content-between mt-4">
                    {% if previous_url %}
                        <a href="{{ previous_url }}"
                           hx-get="{{ previous_url }}"
                           hx-target="#content-area"
                           hx-swap="innerHTML"
                           hx-push-url="true"
                           class="btn btn-primary"
                           hx-on::after-request="document.body.dispatchEvent(new Event('contentLoaded'))">
                            <i class="bi bi-chevron-left me-2"></i>Sebelumnya
                        </a>
                    {% else %}
                        <button class="btn btn-primary" disabled><i class="bi bi-chevron-left me-2"></i>Sebelumnya</button>
                    {% endif %}
                    {% if next_url %}
                        <a href="{{ next_url }}"
                           hx-get="{{ next_url }}"
                           hx-target="#content-area"
                           hx-swap="innerHTML"
                           hx-push-url="true"
                           class="btn btn-primary"
                           hx-on::after-request="document.body.dispatchEvent(new Event('contentLoaded'))">
                            Selanjutnya<i class="bi bi-chevron-right ms-2"></i>
                        </a>
                    {% else %}
                        <button class="btn btn-primary" disabled>Selanjutnya<i class="bi bi-chevron-right ms-2"></i></button>
                    {% endif %}
                </div>
            {% else %}
                <div class="alert alert-info">Tidak ada konten tersedia untuk kursus ini.</div>
            {% endif %}
        </div>
    </div>
</div>