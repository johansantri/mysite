{% extends 'home/tes.html' %}
{% load static %}

{% block content %}
<div class="container py-5">
  <h2 class="mb-4 fw-bold text-primary">Partner Analytics Dashboard</h2>

  <!-- Filter and Download -->
  <form method="get" class="row g-3 mb-4">
    <div class="col-md-4">
      <input type="text" name="univ" class="form-control" placeholder="Search Universitas" value="{{ request.GET.univ }}">
    </div>
    <div class="col-md-2 d-grid">
      <button type="submit" class="btn btn-primary">Filter</button>
    </div>
    <div class="col-md-2 d-grid">
      <a href="?download=csv" class="btn btn-success">
        <i class="bi bi-download"></i> Download CSV
      </a>
    </div>
  </form>

  <div class="row g-4">
    {# Chart Blocks in Loop with Bootstrap Collapse #}
    {% for chart in chart_list %}
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">{{ chart.title }}</h5>
          <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ chart.id }}">
            Toggle
          </button>
        </div>
        <div id="collapse{{ chart.id }}" class="collapse show">
          <div class="card-body">
            <div class="ratio ratio-16x9">
              <canvas id="{{ chart.id }}"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}

    <!-- Balance Summary -->
    <div class="col-md-6">
      <div class="card text-bg-light shadow-sm">
        <div class="card-body">
          <h6 class="card-title">Balance Summary</h6>
          <p>Average: <strong>Rp{{ balance_avg|default_if_none:0 }}</strong></p>
          <p>Min: <strong>Rp{{ balance_min|default_if_none:0 }}</strong></p>
          <p>Max: <strong>Rp{{ balance_max|default_if_none:0 }}</strong></p>

        </div>
      </div>
    </div>

  </div>
</div>

<!-- Chart.js -->
<script src="{% static 'js/chart.umd.min.js' %}"></script>
<script>
  const chartConfigs = {
    growthChart: {type: 'line', data: {{ growth_data|safe }}},
    univChart: {type: 'bar', data: {{ univ_data|safe }}},
    revenueChart: {type: 'bar', data: {{ revenue_data|safe }}},
    monthlyRevenueChart: {type: 'line', data: {{ monthly_revenue_data|safe }}},
    completionChart: {type: 'bar', data: {{ completion_data|safe }}},
    taxChart: {type: 'bar', data: {{ tax_data|safe }}},
    iceiChart: {type: 'bar', data: {{ icei_data|safe }}},
    socialChart: {type: 'bar', data: {{ social_data|safe }}},
    authorChart: {type: 'bar', data: {{ author_data|safe }}},
    courseCountChart: {type: 'bar', data: {{ course_count_data|safe }}},
  };

  for (const [id, config] of Object.entries(chartConfigs)) {
    const ctx = document.getElementById(id);
    if (ctx) {
      new Chart(ctx, {
        type: config.type,
        data: config.data,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: true } },
          layout: { padding: 10 }
        }
      });
    }
  }
</script>
{% endblock %}
