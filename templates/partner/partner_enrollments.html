{% extends 'home/tes.html' %}
{% load extra_custom_filters %}
{% block content %}

<h2 class="mb-3">Enrolled Users ({{ direction|default:"All" }})</h2>

<p class="text-muted">Total Enrolled Users: <strong>{{ total_users }}</strong></p>


<!-- Filter Form -->
<form method="get" class="row g-2 mb-4 align-items-end">
  <div class="col-md-4">
    <label for="direction" class="form-label">Filter by Enrollment Direction</label>
    <select name="direction" id="direction" class="form-select">
      <option value="">-- All --</option>
      <option value="inbound" {% if direction == 'inbound' %}selected{% endif %}>Inbound (Users from other universities)</option>
      <option value="outbound" {% if direction == 'outbound' %}selected{% endif %}>Outbound (My university to other courses)</option>
      <option value="internal" {% if direction == 'internal' %}selected{% endif %}>Internal (My university to our courses)</option>
    </select>
  </div>

  <div class="col-md-3">
    <label for="search" class="form-label">Search by Email</label>
    <input type="text" id="search" name="search" value="{{ request.GET.search }}" class="form-control" placeholder="e.g. user@example.com">
  </div>

  <div class="col-md-2">
    <button type="submit" class="btn btn-primary w-100">Filter</button>
  </div>

  <div class="col-md-3 text-end">
    <label class="form-label d-block">&nbsp;</label>
    <a href="{% url 'partner:export_enrollments_csv' %}?direction={{ direction }}&search={{ request.GET.search }}" class="btn btn-success w-100">
      <i class="bi bi-download"></i> Download CSV
    </a>
  </div>
</form>


<!-- Table -->
<div class="table-responsive">
  <table class="table table-hover align-middle table-bordered shadow-sm">
    <thead class="table-primary text-center">
      <tr>
        <th>ğŸ‘¤ Username</th>
        <th>ğŸ“§ Email</th>
        <th>ğŸ›ï¸ University</th>
        <th>ğŸ“š Courses Enrolled</th>
      </tr>
    </thead>
    <tbody>
      {% for user in users %}
      <tr>
        <td class="fw-semibold text-primary">{{ user.username }}</td>
        <td>{{ user.email }}</td>
        <td>{{ user.university.name|default:"-" }}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#courses-{{ user.id }}">
            Show Details
          </button>
          <div class="collapse mt-2" id="courses-{{ user.id }}">
            {% with user_courses_map|get_item:user.id as courses %}
              {% if courses %}
                <ul class="list-group mt-2">
                  {% for c in courses %}
                  <li class="list-group-item">
                    <div class="fw-bold">{{ c.name }}</div>
                    <div class="small text-muted mb-1">
                      Progress: <span class="text-success">{{ c.progress }}%</span> |
                      Score: <span class="text-info">{{ c.score|floatformat:2 }}%</span>
                    </div>
                    <div>
                      <span class="badge bg-{% if c.passed %}success{% else %}secondary{% endif %}">
                        {% if c.passed %}Pass{% else %}Not Yet{% endif %}
                      </span>
                      {% if not c.passed and c.eligible %}
                        <span class="badge bg-info">Eligible</span>
                      {% endif %}
                    </div>
                  </li>
                  {% endfor %}
                </ul>
              {% else %}
                <p class="text-muted mt-2"><em>No courses found.</em></p>
              {% endif %}
            {% endwith %}
          </div>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="4" class="text-center text-muted">No users found.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>


<!-- Pagination -->
{% if users.has_other_pages %}
<nav aria-label="User pagination">
  <ul class="pagination justify-content-center">
    {% if users.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?page={{ users.previous_page_number }}&direction={{ direction }}">Previous</a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Previous</span></li>
    {% endif %}

    {% for num in users.paginator.page_range %}
      <li class="page-item {% if users.number == num %}active{% endif %}">
        <a class="page-link" href="?page={{ num }}&direction={{ direction }}">{{ num }}</a>
      </li>
    {% endfor %}

    {% if users.has_next %}
      <li class="page-item">
        <a class="page-link" href="?page={{ users.next_page_number }}&direction={{ direction }}">Next</a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Next</span></li>
    {% endif %}
  </ul>
</nav>
{% endif %}

{% endblock %}
