{% extends 'home/tes.html' %}
{% load static custom_filters %}

{% block content %}
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-10">
      <!-- Judul & Subjudul -->
      <h2 class="text-center mb-4 text-primary fw-bold">
        <i class="bi bi-clock-history me-2"></i>Learning Duration Analytics
      </h2>
      <p class="text-center text-muted mb-5 lead">
        Monitor study time across courses to better understand learner engagement.
      </p>

      <!-- Navigasi -->
      <div class="d-flex flex-column flex-md-row justify-content-center gap-3 mb-5">
        <a href="{% url 'partner:partner_analytics' %}" class="btn btn-outline-primary">
          <i class="bi bi-bar-chart-line me-2"></i>Back to Main Analytics
        </a>
      </div>

      <!-- Stat Box Durasi Mingguan & Bulanan -->
      <div class="row mb-5">
        <div class="col-12 col-sm-6 mb-4 mb-sm-0">
          <div class="card text-center border-0 shadow-lg rounded-3 h-100">
            <div class="card-body py-4">
              <h6 class="text-muted mb-2"><i class="bi bi-clock me-1"></i>Weekly Duration</h6>
              <h3 class="fw-bold text-primary mb-0">{{ weekly_minutes }} mins</h3>
            </div>
          </div>
        </div>
        <div class="col-12 col-sm-6">
          <div class="card text-center border-0 shadow-lg rounded-3 h-100">
            <div class="card-body py-4">
              <h6 class="text-muted mb-2"><i class="bi bi-calendar3 me-1"></i>Monthly Duration</h6>
              <h3 class="fw-bold text-success mb-0">{{ monthly_minutes }} mins</h3>
            </div>
          </div>
        </div>
      </div>

      <!-- Chart Durasi per Course -->
      {% if duration_by_course %}
      <div class="card shadow-lg border-0 rounded-3 mb-5">
        <div class="card-body p-4">
          <h3 class="text-center text-muted mb-3">Study Duration per Course</h3>
          <div class="chart-container position-relative rounded bg-light p-3">
            <canvas id="durationChart"></canvas>
          </div>
        </div>
      </div>
      {% else %}
      <div class="alert alert-info text-center" role="alert">
        <i class="bi bi-info-circle me-2"></i>No study duration data available for the selected period.
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- CDN Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<!-- Chart.js -->
<script src="{% static 'js/chart.umd.min.js' %}"></script>

{% if duration_by_course %}
<script>
  const durationChart = document.getElementById('durationChart');
  new Chart(durationChart, {
    type: 'bar',
    data: {
      labels: {{ duration_by_course|pluck:"course__course_name"|safe }},
      datasets: [{
        label: 'Minutes Spent',
        data: {{ duration_by_course|pluck:"total_minutes"|safe }},
        backgroundColor: 'rgba(255, 193, 7, 0.8)',
        borderColor: '#d97706',
        borderWidth: 1,
        hoverBackgroundColor: '#d97706',
        hoverBorderColor: '#92400e'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: {
        duration: 1000,
        easing: 'easeInOutQuad'
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(17, 24, 39, 0.9)',
          titleFont: { size: 14, weight: 'bold' },
          bodyFont: { size: 12 },
          padding: 12,
          cornerRadius: 6,
          callbacks: {
            title: d => d[0].label,
            label: d => `Minutes: ${d.raw}`
          }
        }
      },
      scales: {
        x: {
          title: {
            display: true,
            text: 'Course',
            font: { size: 14, weight: 'bold' },
            color: '#1e40af',
            padding: 10
          },
          grid: { display: false },
          ticks: {
            color: '#4b5563',
            font: { size: 12 },
            maxRotation: 45,
            minRotation: 30
          }
        },
        y: {
          title: {
            display: true,
            text: 'Minutes',
            font: { size: 14, weight: 'bold' },
            color: '#1e40af',
            padding: 10
          },
          beginAtZero: true,
          grid: { color: 'rgba(0, 0, 0, 0.1)' },
          ticks: { color: '#4b5563', font: { size: 12 } }
        }
      }
    }
  });
</script>
{% endif %}

<style>
  .chart-container {
    height: 350px;
    transition: all 0.3s ease;
  }
  .chart-container:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }
</style>
{% endblock %}
