{% extends 'home/tes.html' %}
{% load humanize %}

{% block content %}
<div class="py-5">
  {% if payment %}
    <div class="card shadow-sm border-0">
      <!-- Card Header -->
      <div class="card-header bg-white border-bottom">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2">
          <div>
            <h4 class="fw-bold mb-0">Transaction Invoice</h4>
            <small class="text-muted">Transaction ID: 
              <code>{{ payment.linked_transaction.id|default:"-" }}</code>
            </small>
          </div>
          <div>
            <span class="badge 
              {% if payment.status == 'completed' %} bg-success
              {% elif payment.status == 'pending' %} bg-warning text-dark
              {% else %} bg-danger {% endif %}">
              {{ payment.get_status_display }}
            </span>
          </div>
        </div>
      </div>

      <div class="card-body">
        <div class="row gy-4">
          <!-- User Info -->
          <div class="col-md-6">
            <h6 class="fw-semibold mb-3">User Information</h6>
            <ul class="list-unstyled small mb-0">
              <li><strong>Name:</strong> {{ payment.user.get_full_name|default:payment.user.username }}</li>
              <li><strong>Email:</strong> {{ payment.user.email }}</li>
              <li><strong>IP Address:</strong> {{ payment.ip_address|default:"-" }}</li>
              <li><strong>User Agent:</strong><br><span class="text-muted">{{ payment.user_agent|default:"-" }}</span></li>
              <li><strong>Location:</strong> {{ payment.location|default:"-" }}</li>
              <li><strong>ISP:</strong> {{ payment.isp|default:"-" }}</li>
            </ul>
          </div>

          <!-- Course / Transaction Info -->
          <div class="col-md-6">
            <h6 class="fw-semibold mb-3">Transaction Information</h6>
            <ul class="list-unstyled small mb-0">
              

              {% if transaction %}
              <li><strong>Transaction ID:</strong> {{ transaction.transaction_id }}</li>
              <li><strong>Merchant Reference:</strong> {{ transaction.merchant_ref }}</li>
              <li><strong>Status:</strong> {{ transaction.status|title }}</li>
              <li><strong>Payment Method:</strong> {{ transaction.payment_method|default:"-" }}</li>
              <li><strong>Bank / VA:</strong> {{ transaction.bank_name|default:"-" }} ({{ transaction.va_number|default:"-" }})</li>
              <li><strong>Expiration:</strong> {{ transaction.expired_at|date:"d M Y H:i"|default:"-" }}</li>
              {% endif %}
            </ul>
          </div>
        </div>

        <hr class="my-4">

        <!-- Courses Table -->
        <h4>Courses in this Transaction</h4>
        <div class="table-responsive">
          <table class="table table-bordered table-striped">
            <thead class="thead-light">
              <tr>
                <th>No</th>
                <th>Course Name</th>
                <th>Partner</th>
                <th>Payment Model</th>
               
              </tr>
            </thead>
            <tbody>
              {% for p in transaction.payments.all %}
                <tr>
                  <td>{{ forloop.counter }}</td>
                  <td>{{ p.course.course_name }}</td>
                  <td>{{ p.course.org_partner.name.name }}</td>
                  <td>{{ p.get_payment_model_display }}</td>
                 
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Transaction Time and Total -->
        <div class="row gy-3 mt-4">
          <div class="col-md-6">
            <h6 class="fw-semibold mb-3">Transaction Time</h6>
            <ul class="list-unstyled small mb-0">
              <li><strong>Created At:</strong> {{ payment.created_at|date:"Y-m-d H:i" }}</li>
              <li><strong>Last Updated:</strong> {{ payment.updated_at|date:"Y-m-d H:i" }}</li>
            </ul>
          </div>
          <div class="col-md-6">
            <h6 class="fw-semibold mb-3">Total Amount</h6>
            <p class="fs-4 fw-bold text-success mb-0">Rp {{ payment.amount|floatformat:0|intcomma }}</p>
          </div>
        </div>
      </div>

      <!-- Price Snapshot -->
      <div class="card-body bg-light border-top">
        <h6 class="fw-semibold mb-3">Price Details at the Time of Transaction</h6>
        <div class="row small gy-3">
          <div class="col-md-4">
            <ul class="list-unstyled mb-0">
              <li><strong>Normal Price:</strong> Rp {{ payment.snapshot_price|intcomma }}</li>
              <li><strong>Discount:</strong> Rp {{ payment.snapshot_discount|intcomma }}</li>
              <li><strong>Tax (%):</strong> {{ payment.snapshot_tax }}</li>
            </ul>
          </div>
          <div class="col-md-4">
            <ul class="list-unstyled mb-0">
              <li><strong>VAT:</strong> Rp {{ payment.snapshot_ppn|intcomma }}</li>
              <li><strong>Total Paid:</strong> <span class="fw-bold text-success">Rp {{ payment.snapshot_user_payment|intcomma }}</span></li>
            </ul>
          </div>
          <div class="col-md-4">
            <ul class="list-unstyled mb-0">
              <li><strong>To Partner:</strong> Rp {{ payment.snapshot_partner_earning|intcomma }}</li>
              <li><strong>To ICE:</strong> Rp {{ payment.snapshot_ice_earning|intcomma }}</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Proof of Payment -->
      {% if payment.proof_of_payment %}
      <div class="card-body border-top">
        <h6 class="fw-semibold mb-3">Proof of Payment</h6>
        <div class="text-center">
          <a href="{{ payment.proof_of_payment.url }}" target="_blank">
            <img src="{{ payment.proof_of_payment.url }}" alt="Payment Proof" class="img-fluid img-thumbnail" style="max-width: 400px;">
          </a>
        </div>
      </div>
      {% endif %}

      <!-- Notes -->
      {% if payment.notes %}
      <div class="card-body border-top bg-white">
        <h6 class="fw-semibold mb-2">Notes</h6>
        <p class="text-muted small mb-0">{{ payment.notes }}</p>
      </div>
      {% endif %}

      <!-- Back Button -->
      <div class="card-footer bg-white text-end">
        <a href="{% url 'payments:invoice_receipt' %}" class="btn btn-outline-secondary btn-sm">‚Üê Back to Report</a>
        

      </div>
    </div>
  {% else %}
    <div class="alert alert-warning text-center" role="alert">
      Transaction not found.
    </div>
  {% endif %}
</div>
{% endblock %}
