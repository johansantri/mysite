{% extends 'home/tes.html' %}
{% block content %}
<style>
    @media print {
        .container {
            width: 100%;
            margin: 0;
            padding: 10px;
        }
        .table {
            font-size: 10pt;
            width: 100%;
            border-collapse: collapse;
        }
        .table th, .table td {
            padding: 5px;
            border: 1px solid #ddd;
        }
        .collapse {
            display: block !important; /* Ensure collapse content is visible in PDF */
        }
        .btn, .input-group {
            display: none; /* Hide buttons and search input in PDF */
        }
        .badge {
            color: #000 !important; /* Ensure badge text is readable */
            border: 1px solid #000;
            background: none !important;
        }
        .card {
            box-shadow: none;
            border: none;
        }
    }
</style>
<div class="container my-5">
    <!-- Report Header -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h1 class="card-title text-primary mb-0">Microcredential Report: {{ report.microcredential_title }}</h1>
                <a href="{% url 'courses:microcredential_report_pdf' report.microcredential_id %}" class="btn btn-danger btn-sm">
    Download PDF
</a>

            </div>
            <div class="row">
                <div class="col-md-6">
                    <p class="mb-2"><strong>Microcredential ID:</strong> {{ report.microcredential_id }}</p>
                    <p class="mb-2"><strong>Total Participants:</strong> {{ report.total_participants }}</p>
                </div>
                <div class="col-md-6">
                    <p class="mb-2"><strong>Threshold (Minimum Score):</strong> {{ report.min_total_score|floatformat:0 }}</p>
                    <p class="mb-2"><strong>Date:</strong> {{ current_date|date:"F d, Y" }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Search -->
    <div class="mb-4">
        <div class="input-group">
            <input type="text" id="searchInput" class="form-control" placeholder="Search by first name, last name, email, country, gender, or university..." aria-label="Participant search">
            <button class="btn btn-outline-primary" type="button" onclick="document.getElementById('searchInput').value=''; searchParticipants();">Clear</button>
        </div>
    </div>

    <!-- Participant List -->
    <h2 class="mb-3">Participant List</h2>
    {% if report.participants %}
    <div class="table-responsive">
        <table class="table table-striped table-hover table-bordered" id="participantTable">
            <thead class="table-primary">
                <tr>
                    <th scope="col">Name</th>
                   
                    <th scope="col">Email</th>
                    <th scope="col">Country</th>
                    <th scope="col">Gender</th>
                    <th scope="col">University</th>
                    <th scope="col">Score</th>
                    <th scope="col">Max Score</th>
                    <th scope="col">Threshold</th>
                    <th scope="col">Status</th>
                    <th scope="col">Certificate</th>
                    <th scope="col"> Details</th>
                </tr>
            </thead>
            <tbody>
                {% for participant in report.participants %}
                <tr>
                    <td>{{ participant.full_name }}</td>
               
                    <td>{{ participant.email }}</td>
                    <td>{{ participant.country }}</td>
                    <td>{{ participant.gender }}</td>
                    <td>{{ participant.university }}</td>
                    <td>{{ participant.total_user_score|floatformat:0 }}</td>
                    <td>{{ participant.total_max_score|floatformat:0 }}</td>
                    <td>{{ participant.min_total_score|floatformat:0 }}</td>
                    <td>
                        <span class="badge {% if participant.microcredential_passed %}bg-success{% else %}bg-danger{% endif %}">
                            {{ participant.microcredential_passed|yesno:"Passed,Failed" }}
                        </span>
                    </td>
                    <td>
                        {% if participant.certificate_id != "N/A" %}
                            {{ participant.certificate_id }}<br>
                            <small class="text-muted">Issued: {{ participant.issued_at|date:"Y-m-d H:i"|default:"N/A" }}</small>
                        {% else %}
                            None
                        {% endif %}
                    </td>
                    <td>
                        <!-- Toggle Button for Course Details -->
                        <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#courseDetails{{ forloop.counter }}" aria-expanded="false" aria-controls="courseDetails{{ forloop.counter }}">
                            View Details
                        </button>
                        <div class="collapse mt-2" id="courseDetails{{ forloop.counter }}">
                            <ul class="list-group">
                                {% for course in participant.course_progress %}
                                <li class="list-group-item">
                                    <strong>{{ course.course_name }}</strong><br>
                                    <span>Score: {{ course.user_score|floatformat:0 }} (Min: {{ course.min_score|floatformat:0 }}, Max: {{ course.max_score|floatformat:0 }})</span><br>
                                    <span>Status: 
                                        <span class="badge {% if course.passed %}bg-success{% else %}bg-danger{% endif %}">
                                            {{ course.passed|yesno:"Passed,Failed" }}
                                        </span>
                                    </span><br>
                                    <span>Completed: {{ course.completed|yesno:"Completed,Not Completed" }}</span>
                                </li>
                                {% empty %}
                                <li class="list-group-item">No course data available</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <!-- Pagination controls -->
        {% if report.participants.has_other_pages %}
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center mt-4">
                {% if report.participants.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ report.participants.previous_page_number }}" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                {% else %}
                    <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
                {% endif %}

                {% for num in report.participants.paginator.page_range %}
                    {% if report.participants.number == num %}
                        <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                    {% elif num >= report.participants.number|add:'-2' and num <= report.participants.number|add:'2' %}
                        <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
                    {% endif %}
                {% endfor %}

                {% if report.participants.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ report.participants.next_page_number }}" aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                {% else %}
                    <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}

    </div>
    {% else %}
    <div class="alert alert-warning" role="alert">
        No participants registered for this microcredential.
    </div>
    {% endif %}
</div>

<!-- Include Bootstrap 5 JS and html2pdf.js -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<!-- JavaScript for Search and Download -->
<script>
    // Search Function
    function searchParticipants() {
        const input = document.getElementById('searchInput').value.toLowerCase();
        const table = document.getElementById('participantTable');
        const rows = table.getElementsByTagName('tr');

        for (let i = 1; i < rows.length; i++) { // Start from 1 to skip header
            const cells = rows[i].getElementsByTagName('td');
            const fullName = cells[0].textContent.toLowerCase(); // full name in one column
            const email = cells[1].textContent.toLowerCase();
            const country = cells[2]?.textContent.toLowerCase() || '';
            const gender = cells[3]?.textContent.toLowerCase() || '';
            const university = cells[4]?.textContent.toLowerCase() || '';

            if (
                fullName.includes(input) ||
                email.includes(input) ||
                country.includes(input) ||
                gender.includes(input) ||
                university.includes(input)
            ) {
                rows[i].style.display = '';
            } else {
                rows[i].style.display = 'none';
            }
        }
    }

    // Event Listener for Search
    document.getElementById('searchInput').addEventListener('input', searchParticipants);

    // Download PDF Function
    document.getElementById('downloadPdf').addEventListener('click', function() {
        // Expand all collapses to ensure course details appear in PDF
        document.querySelectorAll('.collapse').forEach(collapse => {
            collapse.classList.add('show');
        });

        const element = document.querySelector('.container');
        const opt = {
            margin: [0.5, 0.2, 0.5, 0.2], // Reduced side margins
            filename: 'Microcredential_Report_{{ report.microcredential_title|slugify }}_{{ current_date|date:"Ymd" }}.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true },
            jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' },
            pagebreak: { mode: ['avoid-all', 'css', 'legacy'] } // Prevent awkward page breaks
        };

        html2pdf().from(element).set(opt).save().then(() => {
            // Restore collapse state
            document.querySelectorAll('.collapse').forEach(collapse => {
                collapse.classList.remove('show');
            });
        });
    });
</script>

{% endblock %}